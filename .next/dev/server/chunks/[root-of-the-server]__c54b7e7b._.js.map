{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 94, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/resend.js"],"sourcesContent":["import { Resend } from \"resend\";\r\n\r\nexport const resend = new Resend(process.env.RESEND_API_KEY);\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,MAAM,SAAS,IAAI,oJAAM,CAAC,QAAQ,GAAG,CAAC,cAAc"}},
    {"offset": {"line": 105, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/sendEmail.js"],"sourcesContent":["import { resend } from \"./resend\";\r\n\r\nexport async function sendEmail({ to, subject, html }) {\r\n  try {\r\n    return await resend.emails.send({\r\n      from: \"Stampi <no-reply@stampi.in>\",\r\n      to,\r\n      subject,\r\n      html,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Email error:\", error);\r\n    throw error;\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,eAAe,UAAU,EAAE,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE;IACnD,IAAI;QACF,OAAO,MAAM,yHAAM,CAAC,MAAM,CAAC,IAAI,CAAC;YAC9B,MAAM;YACN;YACA;YACA;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gBAAgB;QAC9B,MAAM;IACR;AACF"}},
    {"offset": {"line": 128, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/templates/baseEmail.js"],"sourcesContent":["export function baseEmailTemplate({ title, content }) {\r\n    return `\r\n  <!DOCTYPE html>\r\n  <html>\r\n    <body style=\"margin:0;font-family:Arial;background:#f6f9fc;padding:20px\">\r\n      <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\">\r\n        <tr>\r\n          <td align=\"center\">\r\n            <table width=\"600\" style=\"background:#ffffff;border-radius:8px;padding:24px\">\r\n              <tr>\r\n                <td style=\"text-align:center;font-size:24px;font-weight:bold;color:#6247AA\">\r\n                  Stampi\r\n                </td>\r\n              </tr>\r\n\r\n              <tr><td style=\"padding:20px 0;font-size:18px;font-weight:bold\">\r\n                ${title}\r\n              </td></tr>\r\n\r\n              <tr><td style=\"font-size:15px;color:#444\">\r\n                ${content}\r\n              </td></tr>\r\n\r\n              <tr><td style=\"padding-top:30px;font-size:12px;color:#999;text-align:center\">\r\n                © ${new Date().getFullYear()} Stampi · All rights reserved\r\n              </td></tr>\r\n            </table>\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    </body>\r\n  </html>\r\n  `;\r\n}\r\n"],"names":[],"mappings":";;;;AAAO,SAAS,kBAAkB,EAAE,KAAK,EAAE,OAAO,EAAE;IAChD,OAAO,CAAC;;;;;;;;;;;;;;;gBAeI,EAAE,MAAM;;;;gBAIR,EAAE,QAAQ;;;;kBAIR,EAAE,IAAI,OAAO,WAAW,GAAG;;;;;;;;EAQ3C,CAAC;AACH"}},
    {"offset": {"line": 170, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/templates/otpEmail.js"],"sourcesContent":["import { baseEmailTemplate } from \"./baseEmail\";\r\n\r\nexport function otpEmailTemplate({ otp }) {\r\n    return baseEmailTemplate({\r\n        title: \"Your OTP Code\",\r\n        content: `\r\n      <p>Your one-time password (OTP) is:</p>\r\n\r\n      <div style=\"\r\n        font-size:32px;\r\n        font-weight:bold;\r\n        letter-spacing:6px;\r\n        background:#f3f0ff;\r\n        padding:16px;\r\n        text-align:center;\r\n        border-radius:6px;\r\n        margin:20px 0;\r\n      \">\r\n        ${otp}\r\n      </div>\r\n\r\n      <p>This OTP is valid for <b>5 minutes</b>.</p>\r\n      <p>If you didn’t request this, you can safely ignore this email.</p>\r\n    `,\r\n    });\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,SAAS,iBAAiB,EAAE,GAAG,EAAE;IACpC,OAAO,IAAA,oJAAiB,EAAC;QACrB,OAAO;QACP,SAAS,CAAC;;;;;;;;;;;;;QAaV,EAAE,IAAI;;;;;IAKV,CAAC;IACD;AACJ"}},
    {"offset": {"line": 204, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/email/sendOtpEmail.js"],"sourcesContent":["import { sendEmail } from \"../sendEmail\";\r\nimport { otpEmailTemplate } from \"../templates/otpEmail\";\r\n\r\nexport async function sendOtpEmail({ to, otp }) {\r\n    return sendEmail({\r\n        to,\r\n        subject: \"Your Stampi OTP Code\",\r\n        html: otpEmailTemplate({ otp }),\r\n    });\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,aAAa,EAAE,EAAE,EAAE,GAAG,EAAE;IAC1C,OAAO,IAAA,+HAAS,EAAC;QACb;QACA,SAAS;QACT,MAAM,IAAA,kJAAgB,EAAC;YAAE;QAAI;IACjC;AACJ"}},
    {"offset": {"line": 225, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/rateLimit.js"],"sourcesContent":["// lib/rateLimit.js\r\n\r\nconst rateLimitMap = new Map();\r\n\r\n/**\r\n * Simple rate limiter\r\n * @param {string} key - usually email or IP\r\n * @param {number} limit - max requests\r\n * @param {number} windowMs - time window in ms\r\n * @returns {boolean} allowed or not\r\n */\r\nexport function rateLimit(\r\n    key,\r\n    limit = 5,\r\n    windowMs = 5 * 60 * 1000 // 5 minutes\r\n) {\r\n    const now = Date.now();\r\n    const record = rateLimitMap.get(key);\r\n\r\n    // First request or window expired\r\n    if (!record || now - record.startTime > windowMs) {\r\n        rateLimitMap.set(key, {\r\n            count: 1,\r\n            startTime: now,\r\n        });\r\n        return true;\r\n    }\r\n\r\n    // Exceeded limit\r\n    if (record.count >= limit) {\r\n        return false;\r\n    }\r\n\r\n    // Increase count\r\n    record.count += 1;\r\n    rateLimitMap.set(key, record);\r\n\r\n    return true;\r\n}\r\n"],"names":[],"mappings":"AAAA,mBAAmB;;;;;AAEnB,MAAM,eAAe,IAAI;AASlB,SAAS,UACZ,GAAG,EACH,QAAQ,CAAC,EACT,WAAW,IAAI,KAAK,KAAK,YAAY;AAAb;IAExB,MAAM,MAAM,KAAK,GAAG;IACpB,MAAM,SAAS,aAAa,GAAG,CAAC;IAEhC,kCAAkC;IAClC,IAAI,CAAC,UAAU,MAAM,OAAO,SAAS,GAAG,UAAU;QAC9C,aAAa,GAAG,CAAC,KAAK;YAClB,OAAO;YACP,WAAW;QACf;QACA,OAAO;IACX;IAEA,iBAAiB;IACjB,IAAI,OAAO,KAAK,IAAI,OAAO;QACvB,OAAO;IACX;IAEA,iBAAiB;IACjB,OAAO,KAAK,IAAI;IAChB,aAAa,GAAG,CAAC,KAAK;IAEtB,OAAO;AACX"}},
    {"offset": {"line": 256, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/app/api/auth/otp/send/route.js"],"sourcesContent":["export const dynamic = \"force-dynamic\";\r\nexport const runtime = \"nodejs\";\r\n\r\nimport { NextResponse } from \"next/server\";\r\nimport { sendOtpEmail } from \"@/lib/email/sendOtpEmail\";\r\nimport { rateLimit } from \"@/lib/rateLimit\";\r\n\r\nexport async function POST(req) {\r\n  try {\r\n    const { default: prisma } = await import(\"@/lib/prisma\");\r\n\r\n    const { email, purpose } = await req.json();\r\n\r\n    if (!email) {\r\n      return NextResponse.json({ error: \"Email required\" }, { status: 400 });\r\n    }\r\n\r\n    if (!rateLimit(email)) {\r\n      return NextResponse.json(\r\n        { error: \"Too many OTP requests. Please try again later.\" },\r\n        { status: 429 }\r\n      );\r\n    }\r\n\r\n    const code = Math.floor(100000 + Math.random() * 900000).toString();\r\n    const expiresAt = new Date(Date.now() + 5 * 60 * 1000);\r\n\r\n    await prisma.otp.upsert({\r\n      where: { email },\r\n      update: { code, purpose, expiresAt },\r\n      create: { email, code, purpose, expiresAt },\r\n    });\r\n\r\n    // ⬇️ IMPORTANT: this now uses RESEND automatically\r\n    await sendOtpEmail({ to: email, otp: code });\r\n\r\n    return NextResponse.json({ success: true });\r\n\r\n  } catch (err) {\r\n    console.error(\"[otp send error]\", err);\r\n    return NextResponse.json({ error: \"Server error\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAGA;AACA;AACA;AALO,MAAM,UAAU;AAChB,MAAM,UAAU;;;;AAMhB,eAAe,KAAK,GAAG;IAC5B,IAAI;QACF,MAAM,EAAE,SAAS,MAAM,EAAE,GAAG;QAE5B,MAAM,EAAE,KAAK,EAAE,OAAO,EAAE,GAAG,MAAM,IAAI,IAAI;QAEzC,IAAI,CAAC,OAAO;YACV,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,IAAI,CAAC,IAAA,+HAAS,EAAC,QAAQ;YACrB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAiD,GAC1D;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,OAAO,KAAK,KAAK,CAAC,SAAS,KAAK,MAAM,KAAK,QAAQ,QAAQ;QACjE,MAAM,YAAY,IAAI,KAAK,KAAK,GAAG,KAAK,IAAI,KAAK;QAEjD,MAAM,OAAO,GAAG,CAAC,MAAM,CAAC;YACtB,OAAO;gBAAE;YAAM;YACf,QAAQ;gBAAE;gBAAM;gBAAS;YAAU;YACnC,QAAQ;gBAAE;gBAAO;gBAAM;gBAAS;YAAU;QAC5C;QAEA,mDAAmD;QACnD,MAAM,IAAA,8IAAY,EAAC;YAAE,IAAI;YAAO,KAAK;QAAK;QAE1C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;IAE3C,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,oBAAoB;QAClC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;AACF"}}]
}