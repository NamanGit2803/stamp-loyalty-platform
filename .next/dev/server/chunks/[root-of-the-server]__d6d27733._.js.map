{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/app/api/screenshot/verify/route.js"],"sourcesContent":["export const runtime = \"nodejs\"; // Required for Tesseract.js\r\n\r\nimport { NextResponse } from \"next/server\";\r\nimport crypto from \"crypto\";\r\nimport Tesseract from \"tesseract.js\";\r\nimport { PrismaClient } from \"@prisma/client\";\r\n\r\nconst prisma = new PrismaClient();\r\n\r\n// --------------------------------------\r\n//  OCR HELPERS\r\n// --------------------------------------\r\n\r\nfunction extractAmount(text) {\r\n    const match = text.match(/(?:₹|rs\\.?|inr)?\\s*([0-9]{1,5})\\b/i);\r\n    return match ? parseInt(match[1], 10) : 0;\r\n}\r\n\r\nfunction extractUpiId(text) {\r\n    const match = text.match(/[a-zA-Z0-9.\\-_]+@[a-zA-Z]{2,}/);\r\n    return match ? match[0] : null;\r\n}\r\n\r\nfunction extractUTR(text) {\r\n    const match = text.match(/\\b\\d{6,12}\\b/);\r\n    return match ? match[0] : null;\r\n}\r\n\r\nfunction detectApp(text) {\r\n    const lower = text.toLowerCase();\r\n    if (lower.includes(\"google pay\") || lower.includes(\"gpay\")) return \"gpay\";\r\n    if (lower.includes(\"phonepe\")) return \"phonepe\";\r\n    if (lower.includes(\"paytm\")) return \"paytm\";\r\n    if (lower.includes(\"bhim\")) return \"bhim\";\r\n    return \"unknown\";\r\n}\r\n\r\nfunction detectPaymentStatus(text) {\r\n    const t = text.toLowerCase();\r\n    if (t.includes(\"successful\") || t.includes(\"completed\")) return \"success\";\r\n    if (t.includes(\"failed\")) return \"failed\";\r\n    if (t.includes(\"pending\")) return \"pending\";\r\n    return \"unknown\";\r\n}\r\n\r\n// SHA256 for duplicate detection\r\nfunction sha256(buffer) {\r\n    return crypto.createHash(\"sha256\").update(buffer).digest(\"hex\");\r\n}\r\n\r\n// --------------------------------------\r\n//  MAIN API HANDLER\r\n// --------------------------------------\r\n\r\nexport async function POST(req) {\r\n    try {\r\n        const formData = await req.formData();\r\n        const file = formData.get(\"file\");\r\n        const shopId = formData.get(\"shopId\");\r\n        const phone = formData.get(\"phone\");\r\n\r\n        if (!file || !shopId || !phone) {\r\n            return NextResponse.json({ error: \"Missing file, shopId or phone\" }, { status: 400 });\r\n        }\r\n\r\n        // Convert uploaded file\r\n        const bytes = await file.arrayBuffer();\r\n        const buffer = Buffer.from(bytes);\r\n\r\n        const screenshotHash = sha256(buffer);\r\n\r\n        // --------------------------------------\r\n        // 1️⃣ FETCH SHOP\r\n        // --------------------------------------\r\n        const shop = await prisma.shop.findUnique({\r\n            where: { id: shopId }\r\n        });\r\n\r\n        if (!shop) {\r\n            return NextResponse.json({ error: \"Invalid shopId\" }, { status: 404 });\r\n        }\r\n\r\n        // --------------------------------------\r\n        // 2️⃣ PREVENT DUPLICATE SCREENSHOT\r\n        // --------------------------------------\r\n        const duplicate = await prisma.scanVerification.findFirst({\r\n            where: { shopId, screenshotHash }\r\n        });\r\n\r\n        if (duplicate) {\r\n            return NextResponse.json(\r\n                { error: \"Screenshot already used\", rejectReason: \"duplicate_screenshot\" },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // --------------------------------------\r\n        // 3️⃣ RUN OCR (TESSERACT)\r\n        // --------------------------------------\r\n        const ocrResult = await Tesseract.recognize(buffer, \"eng\");\r\n        const text = ocrResult.data.text;\r\n\r\n        const amount = extractAmount(text);\r\n        const upiId = extractUpiId(text);\r\n        const utr = extractUTR(text);\r\n        const paidAt = new Date(); // If you extract time from OCR, replace here\r\n        const appDetected = detectApp(text);\r\n        const paymentStatus = detectPaymentStatus(text);\r\n\r\n        // --------------------------------------\r\n        // 4️⃣ ENSURE CUSTOMER EXISTS\r\n        // --------------------------------------\r\n        let customer = await prisma.customer.findFirst({\r\n            where: { shopId, phone }\r\n        });\r\n\r\n        if (!customer) {\r\n            customer = await prisma.customer.create({\r\n                data: {\r\n                    id: `cus_${crypto.randomUUID()}`,\r\n                    shopId,\r\n                    phone\r\n                }\r\n            });\r\n        }\r\n\r\n        // --------------------------------------\r\n        // 5️⃣ ADVANCED FRAUD CHECKS\r\n        // --------------------------------------\r\n        let rejectReason = null;\r\n\r\n        // UPI mismatch\r\n        if (shop.upiId && upiId && upiId !== shop.upiId) {\r\n            rejectReason = \"upi_mismatch\";\r\n        }\r\n\r\n        // Minimum amount check\r\n        if (!rejectReason && amount < Number(shop.minAmount || 0)) {\r\n            rejectReason = \"below_minimum\";\r\n        }\r\n\r\n        // Payment status check\r\n        if (!rejectReason && paymentStatus !== \"success\") {\r\n            rejectReason = \"payment_not_success\";\r\n        }\r\n\r\n        // Duplicate UTR\r\n        if (!rejectReason) {\r\n            const utrExists = await prisma.scanVerification.findFirst({\r\n                where: { shopId, utr }\r\n            });\r\n            if (utrExists) rejectReason = \"duplicate_utr\";\r\n        }\r\n\r\n        // Daily limit check\r\n        if (!rejectReason) {\r\n            const todayCount = await prisma.scanVerification.count({\r\n                where: {\r\n                    shopId,\r\n                    customerId: customer.id,\r\n                    status: \"success\",\r\n                    createdAt: { gte: new Date(new Date().setHours(0, 0, 0, 0)) }\r\n                }\r\n            });\r\n\r\n            if (todayCount >= shop.maxStampsPerCustomerPerDay) {\r\n                rejectReason = \"daily_limit_reached\";\r\n            }\r\n        }\r\n\r\n        // --------------------------------------\r\n        // 6️⃣ SAVE SCAN VERIFICATION ENTRY\r\n        // --------------------------------------\r\n        const scanRecord = await prisma.scanVerification.create({\r\n            data: {\r\n                shopId,\r\n                customerId: customer.id,\r\n                amount,\r\n                currency: \"INR\",\r\n                upiId,\r\n                utr,\r\n                paidAt,\r\n                status: rejectReason ? \"rejected\" : \"success\",\r\n                rejectReason,\r\n                screenshotHash,\r\n                appDetected,\r\n                ocrText: text\r\n            }\r\n        });\r\n\r\n        // If failed → return now\r\n        if (rejectReason) {\r\n            return NextResponse.json(\r\n                { success: false, rejectReason },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // --------------------------------------\r\n        // 7️⃣ UPDATE CUSTOMER (ADD STAMP)\r\n        // --------------------------------------\r\n        await prisma.customer.update({\r\n            where: { id: customer.id },\r\n            data: {\r\n                stampCount: { increment: 1 },\r\n                totalVisits: { increment: 1 },\r\n                lastVisit: new Date()\r\n            }\r\n        });\r\n\r\n        // --------------------------------------\r\n        // 8️⃣ CREATE TRANSACTION LOG\r\n        // --------------------------------------\r\n        await prisma.transaction.create({\r\n            data: {\r\n                id: `txn_${crypto.randomUUID()}`,\r\n                shopId,\r\n                customerId: customer.id,\r\n                amount,\r\n                status: \"success\",\r\n                upiId,\r\n                method: \"UPI_SCREENSHOT\"\r\n            }\r\n        });\r\n\r\n        // --------------------------------------\r\n        // 9️⃣ SUCCESS RESPONSE\r\n        // --------------------------------------\r\n        return NextResponse.json({\r\n            success: true,\r\n            message: \"Payment verified, stamp added!\",\r\n            scanId: scanRecord.id\r\n        });\r\n\r\n    } catch (err) {\r\n        console.error(\"Verify API ERROR:\", err);\r\n        return NextResponse.json({ error: \"Server Error\" }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}