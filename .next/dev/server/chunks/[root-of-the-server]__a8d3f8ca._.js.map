{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/aiParser.js"],"sourcesContent":["import OpenAI from \"openai\";\r\n\r\nconst client = new OpenAI({\r\n  apiKey: process.env.OPENAI_API_KEY,\r\n});\r\n\r\n// This takes OCR text and extracts clean values\r\nexport async function parsePaymentOCR(ocrText) {\r\n  const prompt = `\r\nYou are an expert at reading Indian UPI payment screenshots.\r\nExtract ONLY these fields:\r\n\r\n- amount (number)\r\n- upiId (string or null)\r\n- utr (string or null)\r\n- appDetected (GPay | PhonePe | Paytm | AmazonPay | UNKNOWN)\r\n- isLikelyFake (true/false)\r\n\r\nOCR text:\r\n${ocrText}\r\n\r\nReturn ONLY JSON with this format:\r\n\r\n{\r\n  \"amount\": number,\r\n  \"upiId\": \"string or null\",\r\n  \"utr\": \"string or null\",\r\n  \"appDetected\": \"GPay/PhonePe/Paytm/AmazonPay/UNKNOWN\",\r\n  \"isLikelyFake\": boolean\r\n}\r\n`;\r\n\r\n  const res = await client.chat.completions.create({\r\n    model: \"gpt-4.1-mini\",\r\n    messages: [\r\n      { role: \"system\", content: \"You correct OCR mistakes and extract structured payment data.\" },\r\n      { role: \"user\", content: prompt }\r\n    ],\r\n    temperature: 0,\r\n  });\r\n\r\n  let json = res.choices[0].message.content;\r\n\r\n  try {\r\n    return JSON.parse(json);\r\n  } catch {\r\n    return { error: \"Invalid JSON from AI\", raw: json };\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AAAA;;AAEA,MAAM,SAAS,IAAI,mLAAM,CAAC;IACxB,QAAQ,QAAQ,GAAG,CAAC,cAAc;AACpC;AAGO,eAAe,gBAAgB,OAAO;IAC3C,MAAM,SAAS,CAAC;;;;;;;;;;;AAWlB,EAAE,QAAQ;;;;;;;;;;;AAWV,CAAC;IAEC,MAAM,MAAM,MAAM,OAAO,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC;QAC/C,OAAO;QACP,UAAU;YACR;gBAAE,MAAM;gBAAU,SAAS;YAAgE;YAC3F;gBAAE,MAAM;gBAAQ,SAAS;YAAO;SACjC;QACD,aAAa;IACf;IAEA,IAAI,OAAO,IAAI,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,OAAO;IAEzC,IAAI;QACF,OAAO,KAAK,KAAK,CAAC;IACpB,EAAE,OAAM;QACN,OAAO;YAAE,OAAO;YAAwB,KAAK;QAAK;IACpD;AACF"}},
    {"offset": {"line": 120, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/app/api/screenshot/verify/route.js"],"sourcesContent":["export const runtime = \"nodejs\";\r\n\r\nimport { NextResponse } from \"next/server\";\r\nimport crypto from \"crypto\";\r\nimport { PrismaClient } from \"@prisma/client\";\r\nimport { parsePaymentOCR } from \"@/lib/aiParser\";\r\n\r\nconst prisma = new PrismaClient();\r\n\r\n/** SHA256 hash generator */\r\nfunction sha256(buffer) {\r\n  return crypto.createHash(\"sha256\").update(buffer).digest(\"hex\");\r\n}\r\n\r\nexport async function POST(req) {\r\n  try {\r\n    const formData = await req.formData();\r\n\r\n    const file = formData.get(\"file\");\r\n    const shopId = formData.get(\"shopId\");\r\n    const phone = formData.get(\"phone\");\r\n    const ocrJson = formData.get(\"ocrResult\");\r\n\r\n    if (!file || !shopId || !ocrJson || !phone) {\r\n      return NextResponse.json(\r\n        { error: \"Missing required fields\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const clientOCR = JSON.parse(ocrJson);\r\n    const { text: rawText } = clientOCR;\r\n\r\n    // --------------------------------------\r\n    // 1️⃣ AI OCR FIX PROCESSING\r\n    // --------------------------------------\r\n    const ai = await parsePaymentOCR(rawText);\r\n\r\n    console.log(\"AI FIXED OCR →\", ai);\r\n\r\n    // AI corrected values (fallback to client OCR)\r\n    const amount = ai.amount ?? clientOCR.amount ?? null;\r\n    const upiId = ai.upiId ?? clientOCR.upiId ?? null;\r\n    const utr = ai.utr ?? clientOCR.utr ?? null;\r\n    const appDetected = ai.appDetected ?? \"UNKNOWN\";\r\n    const isLikelyFake = ai.isLikelyFake ?? false;\r\n\r\n    // Validate amount\r\n    if (!amount || isNaN(amount)) {\r\n      return NextResponse.json(\r\n        { success: false, rejectReason: \"ocr_failed_amount\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // --------------------------------------\r\n    // 2️⃣ HASH ORIGINAL IMAGE (True Duplicate Prevention)\r\n    // --------------------------------------\r\n    const bytes = await file.arrayBuffer();\r\n    const buffer = Buffer.from(bytes);\r\n    const screenshotHash = sha256(buffer);\r\n\r\n    // --------------------------------------\r\n    // 3️⃣ FETCH SHOP\r\n    // --------------------------------------\r\n    const shop = await prisma.shop.findUnique({ where: { id: shopId } });\r\n    if (!shop) {\r\n      return NextResponse.json(\r\n        { error: \"Invalid shopId\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // --------------------------------------\r\n    // 4️⃣ CHECK DUPLICATE SCREENSHOT\r\n    // --------------------------------------\r\n    const duplicate = await prisma.scanVerification.findFirst({\r\n      where: { shopId, screenshotHash },\r\n    });\r\n\r\n    if (duplicate) {\r\n      return NextResponse.json(\r\n        { success: false, rejectReason: \"duplicate_screenshot\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // --------------------------------------\r\n    // 5️⃣ CREATE / FETCH CUSTOMER\r\n    // --------------------------------------\r\n    let customer = await prisma.customer.findFirst({\r\n      where: { shopId, phone },\r\n    });\r\n\r\n    if (!customer) {\r\n      customer = await prisma.customer.create({\r\n        data: {\r\n          id: `cus_${crypto.randomUUID()}`,\r\n          shopId,\r\n          phone,\r\n        },\r\n      });\r\n    }\r\n\r\n    // --------------------------------------\r\n    // 6️⃣ FRAUD CHECKS\r\n    // --------------------------------------\r\n    let rejectReason = null;\r\n\r\n    // AI flagged fake\r\n    if (isLikelyFake) {\r\n      rejectReason = \"suspicious_screenshot\";\r\n    }\r\n\r\n    // UPI mismatch\r\n    if (!rejectReason && shop.upiId && upiId && shop.upiId !== upiId) {\r\n      rejectReason = \"upi_mismatch\";\r\n    }\r\n\r\n    // Minimum amount check\r\n    if (!rejectReason && amount < Number(shop.minAmount || 0)) {\r\n      rejectReason = \"below_minimum\";\r\n    }\r\n\r\n    // Payment status from client OCR (not AI)\r\n    if (!rejectReason && clientOCR.status !== \"success\") {\r\n      rejectReason = \"payment_not_success\";\r\n    }\r\n\r\n    // Duplicate UTR\r\n    if (!rejectReason && utr) {\r\n      const utrExists = await prisma.scanVerification.findFirst({\r\n        where: { shopId, utr },\r\n      });\r\n      if (utrExists) rejectReason = \"duplicate_utr\";\r\n    }\r\n\r\n    // Daily Limit\r\n    if (!rejectReason) {\r\n      const todayCount = await prisma.scanVerification.count({\r\n        where: {\r\n          shopId,\r\n          customerId: customer.id,\r\n          status: \"success\",\r\n          createdAt: {\r\n            gte: new Date(new Date().setHours(0, 0, 0, 0)),\r\n          },\r\n        },\r\n      });\r\n\r\n      if (todayCount >= shop.maxStampsPerCustomerPerDay) {\r\n        rejectReason = \"daily_limit_reached\";\r\n      }\r\n    }\r\n\r\n    // --------------------------------------\r\n    // 7️⃣ SAVE THE VERIFICATION RECORD\r\n    // --------------------------------------\r\n    const scan = await prisma.scanVerification.create({\r\n      data: {\r\n        shopId,\r\n        customerId: customer.id,\r\n        amount,\r\n        currency: \"INR\",\r\n        upiId,\r\n        utr,\r\n        paidAt: new Date(),\r\n        status: rejectReason ? \"rejected\" : \"success\",\r\n        rejectReason,\r\n        screenshotHash,\r\n        appDetected,\r\n        ocrText: rawText,\r\n      },\r\n    });\r\n\r\n    // If failed fraud check → return here\r\n    if (rejectReason) {\r\n      return NextResponse.json(\r\n        { success: false, rejectReason },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // --------------------------------------\r\n    // 8️⃣ AWARD STAMP\r\n    // --------------------------------------\r\n    await prisma.customer.update({\r\n      where: { id: customer.id },\r\n      data: {\r\n        stampCount: { increment: 1 },\r\n        totalVisits: { increment: 1 },\r\n        lastVisit: new Date(),\r\n      },\r\n    });\r\n\r\n    // --------------------------------------\r\n    // 9️⃣ TRANSACTION LOG\r\n    // --------------------------------------\r\n    await prisma.transaction.create({\r\n      data: {\r\n        id: `txn_${crypto.randomUUID()}`,\r\n        shopId,\r\n        customerId: customer.id,\r\n        amount,\r\n        status: \"success\",\r\n        upiId,\r\n        method: \"UPI_SCREENSHOT\",\r\n      },\r\n    });\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      message: \"Stamp added!\",\r\n      scanId: scan.id,\r\n    });\r\n  } catch (err) {\r\n    console.error(\"VERIFY ERROR →\", err);\r\n    return NextResponse.json(\r\n      { error: \"Server Error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}