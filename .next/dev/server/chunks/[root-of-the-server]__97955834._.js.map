{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 94, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/resend.js"],"sourcesContent":["import { Resend } from \"resend\";\r\n\r\nexport const resend = new Resend(process.env.RESEND_API_KEY);\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,MAAM,SAAS,IAAI,oJAAM,CAAC,QAAQ,GAAG,CAAC,cAAc"}},
    {"offset": {"line": 105, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/sendEmail.js"],"sourcesContent":["import { resend } from \"./resend\";\r\n\r\nexport async function sendEmail({ to, subject, html }) {\r\n  try {\r\n    return await resend.emails.send({\r\n      from: \"Stampi <no-reply@stampi.in>\",\r\n      to,\r\n      subject,\r\n      html,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Email error:\", error);\r\n    throw error;\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,eAAe,UAAU,EAAE,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE;IACnD,IAAI;QACF,OAAO,MAAM,yHAAM,CAAC,MAAM,CAAC,IAAI,CAAC;YAC9B,MAAM;YACN;YACA;YACA;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gBAAgB;QAC9B,MAAM;IACR;AACF"}},
    {"offset": {"line": 128, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/templates/baseEmail.js"],"sourcesContent":["export function baseEmailTemplate({ title, content }) {\r\n    return `\r\n  <!DOCTYPE html>\r\n  <html>\r\n    <body style=\"margin:0;font-family:Arial;background:#f6f9fc;padding:20px\">\r\n      <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\">\r\n        <tr>\r\n          <td align=\"center\">\r\n            <table width=\"600\" style=\"background:#ffffff;border-radius:8px;padding:24px\">\r\n              <tr>\r\n                <td style=\"text-align:center;font-size:24px;font-weight:bold;color:#6247AA\">\r\n                  Stampi\r\n                </td>\r\n              </tr>\r\n\r\n              <tr><td style=\"padding:20px 0;font-size:18px;font-weight:bold\">\r\n                ${title}\r\n              </td></tr>\r\n\r\n              <tr><td style=\"font-size:15px;color:#444\">\r\n                ${content}\r\n              </td></tr>\r\n\r\n              <tr><td style=\"padding-top:30px;font-size:12px;color:#999;text-align:center\">\r\n                ¬© ${new Date().getFullYear()} Stampi ¬∑ All rights reserved\r\n              </td></tr>\r\n            </table>\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    </body>\r\n  </html>\r\n  `;\r\n}\r\n"],"names":[],"mappings":";;;;AAAO,SAAS,kBAAkB,EAAE,KAAK,EAAE,OAAO,EAAE;IAChD,OAAO,CAAC;;;;;;;;;;;;;;;gBAeI,EAAE,MAAM;;;;gBAIR,EAAE,QAAQ;;;;kBAIR,EAAE,IAAI,OAAO,WAAW,GAAG;;;;;;;;EAQ3C,CAAC;AACH"}},
    {"offset": {"line": 170, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/templates/tomorrowPlanExpire.js"],"sourcesContent":["import { baseEmailTemplate } from \"./baseEmail\";\r\n\r\nexport function PlanExpiresTomorrowEmail({ shopName, expiryDate, dashboardUrl }) {\r\n    return baseEmailTemplate({\r\n        title: \"Your Plan Expires Tomorrow ‚ö†Ô∏è\",\r\n        content: `\r\n      <p>Hi <strong>${shopName}</strong>,</p>\r\n\r\n      <p>\r\n        This is a friendly reminder that your subscription plan will expire <strong>tomorrow</strong>.\r\n      </p>\r\n\r\n      <p>\r\n        To avoid any interruption in your services, please renew your plan \r\n        before it expires. Renewing on time ensures that you continue to enjoy:\r\n      </p>\r\n\r\n      <ul style=\"padding-left:18px; line-height:1.6;\">\r\n        <li>Unlimited stamp & reward management</li>\r\n        <li>Customer visit & loyalty tracking</li>\r\n        <li>Automated notifications</li>\r\n        <li>Advanced analytics & insights</li>\r\n      </ul>\r\n\r\n      <p style=\"margin-top:20px;\">\r\n        Your plan expires on: <strong>${expiryDate}</strong>\r\n      </p>\r\n\r\n      <a href=\"${dashboardUrl}\"\r\n         style=\"\r\n           display:inline-block;\r\n           padding:12px 24px;\r\n           background:#c9a7ff;\r\n           color:#000;\r\n           border-radius:8px;\r\n           text-decoration:none;\r\n           font-weight:600;\r\n           margin:25px 0;\r\n         \">\r\n        Renew Your Plan\r\n      </a>\r\n\r\n      <p>\r\n        If you already renewed, you can safely ignore this message.\r\n        If you need help, reply to this email anytime!\r\n      </p>\r\n    `,\r\n    });\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,SAAS,yBAAyB,EAAE,QAAQ,EAAE,UAAU,EAAE,YAAY,EAAE;IAC3E,OAAO,IAAA,oJAAiB,EAAC;QACrB,OAAO;QACP,SAAS,CAAC;oBACE,EAAE,SAAS;;;;;;;;;;;;;;;;;;;sCAmBO,EAAE,WAAW;;;eAGpC,EAAE,aAAa;;;;;;;;;;;;;;;;;;IAkB1B,CAAC;IACD;AACJ"}},
    {"offset": {"line": 227, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/email/sendPlanExpiresTomorrowEmail.js"],"sourcesContent":["import { sendEmail } from \"../sendEmail\";\r\nimport { PlanExpiresTomorrowEmail } from \"../templates/tomorrowPlanExpire\";\r\n\r\nexport async function sendPlanExpiresTomorrowEmail({\r\n    to,\r\n    shopName,\r\n    expiryDate,\r\n    dashboardUrl\r\n}) {\r\n    return sendEmail({\r\n        to,\r\n        subject: \"Your Plan Expires Tomorrow ‚ö†Ô∏è\",\r\n        html: PlanExpiresTomorrowEmail({\r\n            shopName,\r\n            expiryDate,\r\n            dashboardUrl,\r\n        }),\r\n    });\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,6BAA6B,EAC/C,EAAE,EACF,QAAQ,EACR,UAAU,EACV,YAAY,EACf;IACG,OAAO,IAAA,+HAAS,EAAC;QACb;QACA,SAAS;QACT,MAAM,IAAA,oKAAwB,EAAC;YAC3B;YACA;YACA;QACJ;IACJ;AACJ"}},
    {"offset": {"line": 250, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/email/sendPlanExpiredEmail.js"],"sourcesContent":["import { sendEmail } from \"../sendEmail\";\r\nimport { PlanExpiredEmailTemplate } from \"../templates/planExpiredEmail\";\r\n\r\nexport async function sendPlanExpiredEmail({\r\n    to,\r\n    shopName,\r\n    expiryDate,\r\n    dashboardUrl\r\n}) {\r\n    return sendEmail({\r\n        to,\r\n        subject: \"Your Plan Has Expired\",\r\n        html: PlanExpiredEmailTemplate({\r\n            shopName,\r\n            expiryDate,\r\n            dashboardUrl,\r\n        }),\r\n    });\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;;;;;;;AAGO,eAAe,qBAAqB,EACvC,EAAE,EACF,QAAQ,EACR,UAAU,EACV,YAAY,EACf;IACG,OAAO,IAAA,+HAAS,EAAC;QACb;QACA,SAAS;QACT,MAAM,yBAAyB;YAC3B;YACA;YACA;QACJ;IACJ;AACJ"}},
    {"offset": {"line": 277, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/app/api/cron/check-plan/route.js"],"sourcesContent":["export const dynamic = \"force-dynamic\";\r\nexport const runtime = \"nodejs\";\r\n\r\nimport { NextResponse } from \"next/server\";\r\nimport { sendPlanExpiresTomorrowEmail } from \"@/lib/email/sendPlanExpiresTomorrowEmail\";\r\nimport { sendPlanExpiredEmail } from \"@/lib/email/sendPlanExpiredEmail\";\r\n\r\nexport async function GET() {\r\n    try {\r\n        const { default: prisma } = await import(\"@/lib/prisma\");\r\n        const resend = new Resend(process.env.RESEND_API_KEY);\r\n\r\n        // -----------------------------------------\r\n        // ‚úÖ FIX: Convert UTC ‚Üí IST for correct logic\r\n        // -----------------------------------------\r\n        const IST_OFFSET = 5.5 * 60 * 60 * 1000;\r\n\r\n        const nowUTC = new Date();\r\n        const nowIST = new Date(nowUTC.getTime() + IST_OFFSET);\r\n\r\n        // IST 00:00 of today and tomorrow\r\n        const startOfTodayIST = new Date(\r\n            nowIST.getFullYear(),\r\n            nowIST.getMonth(),\r\n            nowIST.getDate()\r\n        );\r\n\r\n        const startOfTomorrowIST = new Date(\r\n            nowIST.getFullYear(),\r\n            nowIST.getMonth(),\r\n            nowIST.getDate() + 1\r\n        );\r\n\r\n        // convert back to UTC for DB filtering\r\n        const startTodayUTC = new Date(startOfTodayIST.getTime() - IST_OFFSET);\r\n        const startTomorrowUTC = new Date(startOfTomorrowIST.getTime() - IST_OFFSET);\r\n\r\n        // -----------------------------------------\r\n        // üîç Find subscriptions expiring TODAY (IST)\r\n        // -----------------------------------------\r\n        const subs = await prisma.subscription.findMany({\r\n            where: {\r\n                nextBillingAt: {\r\n                    gte: startTodayUTC,\r\n                    lt: startTomorrowUTC,\r\n                }\r\n            },\r\n            include: {\r\n                shop: true,\r\n                user: true,\r\n            }\r\n        });\r\n\r\n        if (subs.length === 0) {\r\n            return NextResponse.json({ status: \"NO_EXPIRY_TODAY\" });\r\n        }\r\n\r\n        const oneDayMs = 24 * 60 * 60 * 1000; // 24 hours\r\n\r\n        // -----------------------------------------\r\n        // üöÄ Process each subscription\r\n        // -----------------------------------------\r\n        for (const s of subs) {\r\n            // Convert expiry UTC ‚Üí IST\r\n            const expiryUTC = new Date(s.nextBillingAt);\r\n            const expiryIST = new Date(expiryUTC.getTime() + IST_OFFSET);\r\n\r\n            const diff = expiryIST - nowIST;\r\n\r\n            // -------------------------------------------------\r\n            // ‚≠ê 1Ô∏è‚É£ SEND \"24 HOURS BEFORE EXPIRY\" email\r\n            //     (within the 10-minute cron window)\r\n            // -------------------------------------------------\r\n            if (\r\n                diff <= oneDayMs &&\r\n                diff > oneDayMs - 10 * 60 * 1000 // cron = every 10 min\r\n            ) {\r\n                await sendPlanExpiresTomorrowEmail({\r\n                    to: s.shop?.ownerId,\r\n                    shopName: s.shop?.shopName,\r\n                    expiryDate: expiryIST,\r\n                    dashboardUrl: `https://stampi.in/shop/${s.shop?.id}/billing`,\r\n                });\r\n\r\n            }\r\n\r\n            // -------------------------------------------------\r\n            // ‚≠ê 2Ô∏è‚É£ SEND \"PLAN EXPIRED\" EMAIL\r\n            //     when expiry time is passed in IST\r\n            // -------------------------------------------------\r\n            if (expiryIST <= nowIST) {\r\n\r\n                await sendPlanExpiredEmail({\r\n                    to: s.shop?.ownerId,\r\n                    shopName: s.shop?.shopName,\r\n                    expiryDate: expiryIST,\r\n                    dashboardUrl: `https://stampi.in/shop/${s.shop?.id}/billing`,\r\n                });\r\n\r\n            }\r\n        }\r\n\r\n        return NextResponse.json({ status: \"CRON_RAN\" });\r\n\r\n    } catch (err) {\r\n        console.error(\"[CRON ERROR]\", err);\r\n        return NextResponse.json({ status: \"ERROR\" });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAGA;AACA;AACA;AALO,MAAM,UAAU;AAChB,MAAM,UAAU;;;;AAMhB,eAAe;IAClB,IAAI;QACA,MAAM,EAAE,SAAS,MAAM,EAAE,GAAG;QAC5B,MAAM,SAAS,IAAI,OAAO,QAAQ,GAAG,CAAC,cAAc;QAEpD,4CAA4C;QAC5C,6CAA6C;QAC7C,4CAA4C;QAC5C,MAAM,aAAa,MAAM,KAAK,KAAK;QAEnC,MAAM,SAAS,IAAI;QACnB,MAAM,SAAS,IAAI,KAAK,OAAO,OAAO,KAAK;QAE3C,kCAAkC;QAClC,MAAM,kBAAkB,IAAI,KACxB,OAAO,WAAW,IAClB,OAAO,QAAQ,IACf,OAAO,OAAO;QAGlB,MAAM,qBAAqB,IAAI,KAC3B,OAAO,WAAW,IAClB,OAAO,QAAQ,IACf,OAAO,OAAO,KAAK;QAGvB,uCAAuC;QACvC,MAAM,gBAAgB,IAAI,KAAK,gBAAgB,OAAO,KAAK;QAC3D,MAAM,mBAAmB,IAAI,KAAK,mBAAmB,OAAO,KAAK;QAEjE,4CAA4C;QAC5C,6CAA6C;QAC7C,4CAA4C;QAC5C,MAAM,OAAO,MAAM,OAAO,YAAY,CAAC,QAAQ,CAAC;YAC5C,OAAO;gBACH,eAAe;oBACX,KAAK;oBACL,IAAI;gBACR;YACJ;YACA,SAAS;gBACL,MAAM;gBACN,MAAM;YACV;QACJ;QAEA,IAAI,KAAK,MAAM,KAAK,GAAG;YACnB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,QAAQ;YAAkB;QACzD;QAEA,MAAM,WAAW,KAAK,KAAK,KAAK,MAAM,WAAW;QAEjD,4CAA4C;QAC5C,+BAA+B;QAC/B,4CAA4C;QAC5C,KAAK,MAAM,KAAK,KAAM;YAClB,2BAA2B;YAC3B,MAAM,YAAY,IAAI,KAAK,EAAE,aAAa;YAC1C,MAAM,YAAY,IAAI,KAAK,UAAU,OAAO,KAAK;YAEjD,MAAM,OAAO,YAAY;YAEzB,oDAAoD;YACpD,4CAA4C;YAC5C,yCAAyC;YACzC,oDAAoD;YACpD,IACI,QAAQ,YACR,OAAO,WAAW,KAAK,KAAK,KAAK,sBAAsB;cACzD;gBACE,MAAM,IAAA,8KAA4B,EAAC;oBAC/B,IAAI,EAAE,IAAI,EAAE;oBACZ,UAAU,EAAE,IAAI,EAAE;oBAClB,YAAY;oBACZ,cAAc,CAAC,uBAAuB,EAAE,EAAE,IAAI,EAAE,GAAG,QAAQ,CAAC;gBAChE;YAEJ;YAEA,oDAAoD;YACpD,kCAAkC;YAClC,wCAAwC;YACxC,oDAAoD;YACpD,IAAI,aAAa,QAAQ;gBAErB,MAAM,IAAA,8JAAoB,EAAC;oBACvB,IAAI,EAAE,IAAI,EAAE;oBACZ,UAAU,EAAE,IAAI,EAAE;oBAClB,YAAY;oBACZ,cAAc,CAAC,uBAAuB,EAAE,EAAE,IAAI,EAAE,GAAG,QAAQ,CAAC;gBAChE;YAEJ;QACJ;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,QAAQ;QAAW;IAElD,EAAE,OAAO,KAAK;QACV,QAAQ,KAAK,CAAC,gBAAgB;QAC9B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,QAAQ;QAAQ;IAC/C;AACJ"}}]
}