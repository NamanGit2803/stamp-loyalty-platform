{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 94, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/resend.js"],"sourcesContent":["import { Resend } from \"resend\";\r\n\r\nexport const resend = new Resend(process.env.RESEND_API_KEY);\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,MAAM,SAAS,IAAI,oJAAM,CAAC,QAAQ,GAAG,CAAC,cAAc"}},
    {"offset": {"line": 105, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/sendEmail.js"],"sourcesContent":["import { resend } from \"./resend\";\r\n\r\nexport async function sendEmail({ to, subject, html }) {\r\n  try {\r\n    return await resend.emails.send({\r\n      from: \"Stampi <no-reply@stampi.in>\",\r\n      to,\r\n      subject,\r\n      html,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Email error:\", error);\r\n    throw error;\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,eAAe,UAAU,EAAE,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE;IACnD,IAAI;QACF,OAAO,MAAM,yHAAM,CAAC,MAAM,CAAC,IAAI,CAAC;YAC9B,MAAM;YACN;YACA;YACA;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gBAAgB;QAC9B,MAAM;IACR;AACF"}},
    {"offset": {"line": 128, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/templates/baseEmail.js"],"sourcesContent":["export function baseEmailTemplate({ title, content }) {\r\n    return `\r\n  <!DOCTYPE html>\r\n  <html>\r\n    <body style=\"margin:0;font-family:Arial;background:#f6f9fc;padding:20px\">\r\n      <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\">\r\n        <tr>\r\n          <td align=\"center\">\r\n            <table width=\"600\" style=\"background:#ffffff;border-radius:8px;padding:24px\">\r\n              <tr>\r\n                <td style=\"text-align:center;font-size:24px;font-weight:bold;color:#6247AA\">\r\n                  Stampi\r\n                </td>\r\n              </tr>\r\n\r\n              <tr><td style=\"padding:20px 0;font-size:18px;font-weight:bold\">\r\n                ${title}\r\n              </td></tr>\r\n\r\n              <tr><td style=\"font-size:15px;color:#444\">\r\n                ${content}\r\n              </td></tr>\r\n\r\n              <tr><td style=\"padding-top:30px;font-size:12px;color:#999;text-align:center\">\r\n                © ${new Date().getFullYear()} Stampi · All rights reserved\r\n              </td></tr>\r\n            </table>\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    </body>\r\n  </html>\r\n  `;\r\n}\r\n"],"names":[],"mappings":";;;;AAAO,SAAS,kBAAkB,EAAE,KAAK,EAAE,OAAO,EAAE;IAChD,OAAO,CAAC;;;;;;;;;;;;;;;gBAeI,EAAE,MAAM;;;;gBAIR,EAAE,QAAQ;;;;kBAIR,EAAE,IAAI,OAAO,WAAW,GAAG;;;;;;;;EAQ3C,CAAC;AACH"}},
    {"offset": {"line": 170, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/templates/tomorrowPlanExpire.js"],"sourcesContent":["import { baseEmailTemplate } from \"./baseEmail\";\r\n\r\nexport function PlanExpiresTomorrowEmail({ shopName, expiryDate, dashboardUrl }) {\r\n    return baseEmailTemplate({\r\n        title: \"Your Plan Expires Tomorrow ⚠️\",\r\n        content: `\r\n      <p>Hi <strong>${shopName}</strong>,</p>\r\n\r\n      <p>\r\n        This is a friendly reminder that your subscription plan will expire <strong>tomorrow</strong>.\r\n      </p>\r\n\r\n      <p>\r\n        To avoid any interruption in your services, please renew your plan \r\n        before it expires. Renewing on time ensures that you continue to enjoy:\r\n      </p>\r\n\r\n      <ul style=\"padding-left:18px; line-height:1.6;\">\r\n        <li>Unlimited stamp & reward management</li>\r\n        <li>Customer visit & loyalty tracking</li>\r\n        <li>Automated notifications</li>\r\n        <li>Advanced analytics & insights</li>\r\n      </ul>\r\n\r\n      <p style=\"margin-top:20px;\">\r\n        Your plan expires on: <strong>${expiryDate}</strong>\r\n      </p>\r\n\r\n      <a href=\"${dashboardUrl}\"\r\n         style=\"\r\n           display:inline-block;\r\n           padding:12px 24px;\r\n           background:#c9a7ff;\r\n           color:#000;\r\n           border-radius:8px;\r\n           text-decoration:none;\r\n           font-weight:600;\r\n           margin:25px 0;\r\n         \">\r\n        Renew Your Plan\r\n      </a>\r\n\r\n      <p>\r\n        If you already renewed, you can safely ignore this message.\r\n        If you need help, reply to this email anytime!\r\n      </p>\r\n    `,\r\n    });\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,SAAS,yBAAyB,EAAE,QAAQ,EAAE,UAAU,EAAE,YAAY,EAAE;IAC3E,OAAO,IAAA,oJAAiB,EAAC;QACrB,OAAO;QACP,SAAS,CAAC;oBACE,EAAE,SAAS;;;;;;;;;;;;;;;;;;;sCAmBO,EAAE,WAAW;;;eAGpC,EAAE,aAAa;;;;;;;;;;;;;;;;;;IAkB1B,CAAC;IACD;AACJ"}},
    {"offset": {"line": 227, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/email/sendPlanExpiresTomorrowEmail.js"],"sourcesContent":["import { sendEmail } from \"../sendEmail\";\r\nimport { PlanExpiresTomorrowEmail } from \"../templates/tomorrowPlanExpire\";\r\n\r\nexport async function sendPlanExpiresTomorrowEmail({\r\n    to,\r\n    shopName,\r\n    expiryDate,\r\n    dashboardUrl\r\n}) {\r\n    return sendEmail({\r\n        to,\r\n        subject: \"Your Plan Expires Tomorrow ⚠️\",\r\n        html: PlanExpiresTomorrowEmail({\r\n            shopName,\r\n            expiryDate,\r\n            dashboardUrl,\r\n        }),\r\n    });\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,6BAA6B,EAC/C,EAAE,EACF,QAAQ,EACR,UAAU,EACV,YAAY,EACf;IACG,OAAO,IAAA,+HAAS,EAAC;QACb;QACA,SAAS;QACT,MAAM,IAAA,oKAAwB,EAAC;YAC3B;YACA;YACA;QACJ;IACJ;AACJ"}},
    {"offset": {"line": 250, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/templates/planExpired.js"],"sourcesContent":["import { baseEmailTemplate } from \"./baseEmail\";\r\n\r\nexport function PlanExpiredEmailTemplate({ shopName, expiryDate, dashboardUrl }) {\r\n    return baseEmailTemplate({\r\n        title: \"Your Plan Has Expired\",\r\n        content: `\r\n      <p>Hi <strong>${shopName}</strong>,</p>\r\n\r\n      <p>\r\n        Your subscription plan has \r\n        <strong>expired</strong>.\r\n      </p>\r\n\r\n      <p>\r\n        Since your plan is no longer active, certain features such as \r\n        stamp management, customer tracking, rewards, and analytics may become \r\n        unavailable.\r\n      </p>\r\n\r\n      <p style=\"margin-top: 16px;\">\r\n        <strong>Expired on:</strong> ${expiryDate}\r\n      </p>\r\n\r\n      <a href=\"${dashboardUrl}\"\r\n         style=\"\r\n           display:inline-block;\r\n           padding:12px 24px;\r\n           background:#ff6f6f;\r\n           color:#fff;\r\n           border-radius:8px;\r\n           text-decoration:none;\r\n           font-weight:600;\r\n           margin:25px 0;\r\n         \"\r\n      >\r\n        Renew Your Plan\r\n      </a>\r\n\r\n      <p>\r\n        Renew your subscription anytime to instantly regain access to all premium features.\r\n      </p>\r\n\r\n      <p>\r\n        Need help? Just reply to this email—we’re always here.\r\n      </p>\r\n    `,\r\n    });\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,SAAS,yBAAyB,EAAE,QAAQ,EAAE,UAAU,EAAE,YAAY,EAAE;IAC3E,OAAO,IAAA,oJAAiB,EAAC;QACrB,OAAO;QACP,SAAS,CAAC;oBACE,EAAE,SAAS;;;;;;;;;;;;;;qCAcM,EAAE,WAAW;;;eAGnC,EAAE,aAAa;;;;;;;;;;;;;;;;;;;;;;IAsB1B,CAAC;IACD;AACJ"}},
    {"offset": {"line": 306, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/email/sendPlanExpiredEmail.js"],"sourcesContent":["import { sendEmail } from \"../sendEmail\";\r\nimport { PlanExpiredEmailTemplate } from \"../templates/planExpired\";\r\n\r\nexport async function sendPlanExpiredEmail({\r\n    to,\r\n    shopName,\r\n    expiryDate,\r\n    dashboardUrl\r\n}) {\r\n    return sendEmail({\r\n        to,\r\n        subject: \"Your Plan Has Expired\",\r\n        html: PlanExpiredEmailTemplate({\r\n            shopName,\r\n            expiryDate,\r\n            dashboardUrl,\r\n        }),\r\n    });\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,qBAAqB,EACvC,EAAE,EACF,QAAQ,EACR,UAAU,EACV,YAAY,EACf;IACG,OAAO,IAAA,+HAAS,EAAC;QACb;QACA,SAAS;QACT,MAAM,IAAA,6JAAwB,EAAC;YAC3B;YACA;YACA;QACJ;IACJ;AACJ"}},
    {"offset": {"line": 329, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/app/api/cron/check-plan/route.js"],"sourcesContent":["export const dynamic = \"force-dynamic\";\r\nexport const runtime = \"nodejs\";\r\n\r\nimport { NextResponse } from \"next/server\";\r\nimport { sendPlanExpiresTomorrowEmail } from \"@/lib/email/sendPlanExpiresTomorrowEmail\";\r\nimport { sendPlanExpiredEmail } from \"@/lib/email/sendPlanExpiredEmail\";\r\n\r\nexport async function GET() {\r\n    try {\r\n        const { default: prisma } = await import(\"@/lib/prisma\");\r\n\r\n        // -----------------------------------------\r\n        //  IST TIME SUPPORT\r\n        // -----------------------------------------\r\n        const IST_OFFSET = 5.5 * 60 * 60 * 1000;\r\n        const nowUTC = new Date();\r\n        const nowIST = new Date(nowUTC.getTime() + IST_OFFSET);\r\n\r\n        // TODAY IST 00:00\r\n        const startTodayIST = new Date(nowIST.getFullYear(), nowIST.getMonth(), nowIST.getDate());\r\n\r\n        // TOMORROW IST 00:00\r\n        const startTomorrowIST = new Date(nowIST.getFullYear(), nowIST.getMonth(), nowIST.getDate() + 1);\r\n\r\n        // DAY AFTER TOMORROW IST 00:00\r\n        const startDayAfterIST = new Date(nowIST.getFullYear(), nowIST.getMonth(), nowIST.getDate() + 2);\r\n\r\n        // Convert to UTC for DB\r\n        const startTodayUTC = new Date(startTodayIST.getTime() - IST_OFFSET);\r\n        const startTomorrowUTC = new Date(startTomorrowIST.getTime() - IST_OFFSET);\r\n        const startDayAfterUTC = new Date(startDayAfterIST.getTime() - IST_OFFSET);\r\n\r\n        // -----------------------------------------\r\n        // 1️⃣ EXPIRING TODAY (for expired email)\r\n        // -----------------------------------------\r\n        const subsExpiringToday = await prisma.subscription.findMany({\r\n            where: {\r\n                nextBillingAt: {\r\n                    gte: startTodayUTC,\r\n                    lt: startTomorrowUTC,\r\n                }\r\n            },\r\n            include: { shop: true }\r\n        });\r\n\r\n        // -----------------------------------------\r\n        // 2️⃣ EXPIRING TOMORROW (for 24h-before email)\r\n        // -----------------------------------------\r\n        const subsExpiringTomorrow = await prisma.subscription.findMany({\r\n            where: {\r\n                nextBillingAt: {\r\n                    gte: startTomorrowUTC,\r\n                    lt: startDayAfterUTC,\r\n                }\r\n            },\r\n            include: { shop: true }\r\n        });\r\n\r\n        const oneDayMs = 24 * 60 * 60 * 1000;\r\n\r\n\r\n        // ---------------------------------------------------\r\n        // ⭐ EXPIRED EMAIL (Expiry Today)\r\n        // ---------------------------------------------------\r\n        for (const s of subsExpiringToday) {\r\n            const expiryUTC = new Date(s.nextBillingAt);\r\n            const expiryIST = new Date(expiryUTC.getTime() + IST_OFFSET);\r\n\r\n            if (expiryIST <= nowIST) {\r\n                await sendPlanExpiredEmail({\r\n                    to: s.shop?.ownerId,\r\n                    shopName: s.shop?.shopName,\r\n                    expiryDate: expiryIST,\r\n                    dashboardUrl: `https://stampi.in/shop/${s.shop?.id}/billing`,\r\n                });\r\n            }\r\n        }\r\n\r\n        // ---------------------------------------------------\r\n        // ⭐ 24 HOURS BEFORE EMAIL (Expiry Tomorrow)\r\n        // ---------------------------------------------------\r\n        for (const s of subsExpiringTomorrow) {\r\n\r\n            const expiryUTC = new Date(s.nextBillingAt);\r\n            const expiryIST = new Date(expiryUTC.getTime() + IST_OFFSET);\r\n\r\n            const diff = expiryIST - nowIST;\r\n\r\n            console.log(subsExpiringTomorrow, expiryIST, nowIST)\r\n\r\n            // 10-minute cron window around 24 hours\r\n            if (diff <= oneDayMs && diff > oneDayMs - 10 * 60 * 1000) {\r\n\r\n                await sendPlanExpiresTomorrowEmail({\r\n                    to: s.shop?.ownerId,\r\n                    shopName: s.shop?.shopName,\r\n                    expiryDate: expiryIST,\r\n                    dashboardUrl: `https://stampi.in/shop/${s.shop?.id}/billing`,\r\n                });\r\n            }\r\n        }\r\n\r\n        return NextResponse.json({ status: \"CRON_RAN\" });\r\n\r\n    } catch (err) {\r\n        console.error(\"[CRON ERROR]\", err);\r\n        return NextResponse.json({ status: \"ERROR\" });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAGA;AACA;AACA;AALO,MAAM,UAAU;AAChB,MAAM,UAAU;;;;AAMhB,eAAe;IAClB,IAAI;QACA,MAAM,EAAE,SAAS,MAAM,EAAE,GAAG;QAE5B,4CAA4C;QAC5C,oBAAoB;QACpB,4CAA4C;QAC5C,MAAM,aAAa,MAAM,KAAK,KAAK;QACnC,MAAM,SAAS,IAAI;QACnB,MAAM,SAAS,IAAI,KAAK,OAAO,OAAO,KAAK;QAE3C,kBAAkB;QAClB,MAAM,gBAAgB,IAAI,KAAK,OAAO,WAAW,IAAI,OAAO,QAAQ,IAAI,OAAO,OAAO;QAEtF,qBAAqB;QACrB,MAAM,mBAAmB,IAAI,KAAK,OAAO,WAAW,IAAI,OAAO,QAAQ,IAAI,OAAO,OAAO,KAAK;QAE9F,+BAA+B;QAC/B,MAAM,mBAAmB,IAAI,KAAK,OAAO,WAAW,IAAI,OAAO,QAAQ,IAAI,OAAO,OAAO,KAAK;QAE9F,wBAAwB;QACxB,MAAM,gBAAgB,IAAI,KAAK,cAAc,OAAO,KAAK;QACzD,MAAM,mBAAmB,IAAI,KAAK,iBAAiB,OAAO,KAAK;QAC/D,MAAM,mBAAmB,IAAI,KAAK,iBAAiB,OAAO,KAAK;QAE/D,4CAA4C;QAC5C,yCAAyC;QACzC,4CAA4C;QAC5C,MAAM,oBAAoB,MAAM,OAAO,YAAY,CAAC,QAAQ,CAAC;YACzD,OAAO;gBACH,eAAe;oBACX,KAAK;oBACL,IAAI;gBACR;YACJ;YACA,SAAS;gBAAE,MAAM;YAAK;QAC1B;QAEA,4CAA4C;QAC5C,+CAA+C;QAC/C,4CAA4C;QAC5C,MAAM,uBAAuB,MAAM,OAAO,YAAY,CAAC,QAAQ,CAAC;YAC5D,OAAO;gBACH,eAAe;oBACX,KAAK;oBACL,IAAI;gBACR;YACJ;YACA,SAAS;gBAAE,MAAM;YAAK;QAC1B;QAEA,MAAM,WAAW,KAAK,KAAK,KAAK;QAGhC,sDAAsD;QACtD,iCAAiC;QACjC,sDAAsD;QACtD,KAAK,MAAM,KAAK,kBAAmB;YAC/B,MAAM,YAAY,IAAI,KAAK,EAAE,aAAa;YAC1C,MAAM,YAAY,IAAI,KAAK,UAAU,OAAO,KAAK;YAEjD,IAAI,aAAa,QAAQ;gBACrB,MAAM,IAAA,8JAAoB,EAAC;oBACvB,IAAI,EAAE,IAAI,EAAE;oBACZ,UAAU,EAAE,IAAI,EAAE;oBAClB,YAAY;oBACZ,cAAc,CAAC,uBAAuB,EAAE,EAAE,IAAI,EAAE,GAAG,QAAQ,CAAC;gBAChE;YACJ;QACJ;QAEA,sDAAsD;QACtD,4CAA4C;QAC5C,sDAAsD;QACtD,KAAK,MAAM,KAAK,qBAAsB;YAElC,MAAM,YAAY,IAAI,KAAK,EAAE,aAAa;YAC1C,MAAM,YAAY,IAAI,KAAK,UAAU,OAAO,KAAK;YAEjD,MAAM,OAAO,YAAY;YAEzB,QAAQ,GAAG,CAAC,sBAAsB,WAAW;YAE7C,wCAAwC;YACxC,IAAI,QAAQ,YAAY,OAAO,WAAW,KAAK,KAAK,MAAM;gBAEtD,MAAM,IAAA,8KAA4B,EAAC;oBAC/B,IAAI,EAAE,IAAI,EAAE;oBACZ,UAAU,EAAE,IAAI,EAAE;oBAClB,YAAY;oBACZ,cAAc,CAAC,uBAAuB,EAAE,EAAE,IAAI,EAAE,GAAG,QAAQ,CAAC;gBAChE;YACJ;QACJ;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,QAAQ;QAAW;IAElD,EAAE,OAAO,KAAK;QACV,QAAQ,KAAK,CAAC,gBAAgB;QAC9B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,QAAQ;QAAQ;IAC/C;AACJ"}}]
}