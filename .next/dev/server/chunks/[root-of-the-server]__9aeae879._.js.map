{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/rateLimit.js"],"sourcesContent":["// lib/rateLimit.js\r\n\r\nconst rateLimitMap = new Map();\r\n\r\n/**\r\n * Simple rate limiter\r\n * @param {string} key - usually email or IP\r\n * @param {number} limit - max requests\r\n * @param {number} windowMs - time window in ms\r\n * @returns {boolean} allowed or not\r\n */\r\nexport function rateLimit(\r\n    key,\r\n    limit = 5,\r\n    windowMs = 5 * 60 * 1000 // 5 minutes\r\n) {\r\n    const now = Date.now();\r\n    const record = rateLimitMap.get(key);\r\n\r\n    // First request or window expired\r\n    if (!record || now - record.startTime > windowMs) {\r\n        rateLimitMap.set(key, {\r\n            count: 1,\r\n            startTime: now,\r\n        });\r\n        return true;\r\n    }\r\n\r\n    // Exceeded limit\r\n    if (record.count >= limit) {\r\n        return false;\r\n    }\r\n\r\n    // Increase count\r\n    record.count += 1;\r\n    rateLimitMap.set(key, record);\r\n\r\n    return true;\r\n}\r\n"],"names":[],"mappings":"AAAA,mBAAmB;;;;;AAEnB,MAAM,eAAe,IAAI;AASlB,SAAS,UACZ,GAAG,EACH,QAAQ,CAAC,EACT,WAAW,IAAI,KAAK,KAAK,YAAY;AAAb;IAExB,MAAM,MAAM,KAAK,GAAG;IACpB,MAAM,SAAS,aAAa,GAAG,CAAC;IAEhC,kCAAkC;IAClC,IAAI,CAAC,UAAU,MAAM,OAAO,SAAS,GAAG,UAAU;QAC9C,aAAa,GAAG,CAAC,KAAK;YAClB,OAAO;YACP,WAAW;QACf;QACA,OAAO;IACX;IAEA,iBAAiB;IACjB,IAAI,OAAO,KAAK,IAAI,OAAO;QACvB,OAAO;IACX;IAEA,iBAAiB;IACjB,OAAO,KAAK,IAAI;IAChB,aAAa,GAAG,CAAC,KAAK;IAEtB,OAAO;AACX"}},
    {"offset": {"line": 77, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/app/api/auth/otp/send/route.js"],"sourcesContent":["export const dynamic = \"force-dynamic\";\r\nexport const runtime = \"nodejs\";\r\n\r\nimport { NextResponse } from \"next/server\";\r\nimport { sendOtpEmail } from \"@/lib/sendOtpEmail\";\r\nimport { rateLimit } from \"@/lib/rateLimit\";\r\n\r\nexport async function POST(req) {\r\n  try {\r\n    // Lazy import Prisma (build-safe)\r\n    const { default: prisma } = await import(\"@/lib/prisma\");\r\n\r\n    const { email, purpose } = await req.json();\r\n\r\n    if (!email) {\r\n      return NextResponse.json(\r\n        { error: \"Email required\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Rate limit OTP requests\r\n    if (!rateLimit(email)) {\r\n      return NextResponse.json(\r\n        { error: \"Too many OTP requests. Please try again later.\" },\r\n        { status: 429 }\r\n      );\r\n    }\r\n\r\n    // Generate 6-digit OTP\r\n    const code = Math.floor(100000 + Math.random() * 900000).toString();\r\n    const expiresAt = new Date(Date.now() + 5 * 60 * 1000);\r\n\r\n    // Save OTP to DB\r\n    await prisma.otp.upsert({\r\n      where: { email },\r\n      update: {\r\n        code,\r\n        purpose,\r\n        expiresAt,\r\n      },\r\n      create: {\r\n        email,\r\n        code,\r\n        purpose,\r\n        expiresAt,\r\n      },\r\n    });\r\n\r\n    // âœ… Send OTP via AWS SES\r\n    await sendOtpEmail({\r\n      to: email,\r\n      otp: code,\r\n    });\r\n\r\n    return NextResponse.json({ success: true });\r\n\r\n  } catch (err) {\r\n    console.error(\"[otp send error]\", err);\r\n    return NextResponse.json(\r\n      { error: \"Server error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAGA;;;;;;AAEA;AALO,MAAM,UAAU;AAChB,MAAM,UAAU;;;;AAMhB,eAAe,KAAK,GAAG;IAC5B,IAAI;QACF,kCAAkC;QAClC,MAAM,EAAE,SAAS,MAAM,EAAE,GAAG;QAE5B,MAAM,EAAE,KAAK,EAAE,OAAO,EAAE,GAAG,MAAM,IAAI,IAAI;QAEzC,IAAI,CAAC,OAAO;YACV,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAiB,GAC1B;gBAAE,QAAQ;YAAI;QAElB;QAEA,0BAA0B;QAC1B,IAAI,CAAC,IAAA,+HAAS,EAAC,QAAQ;YACrB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAiD,GAC1D;gBAAE,QAAQ;YAAI;QAElB;QAEA,uBAAuB;QACvB,MAAM,OAAO,KAAK,KAAK,CAAC,SAAS,KAAK,MAAM,KAAK,QAAQ,QAAQ;QACjE,MAAM,YAAY,IAAI,KAAK,KAAK,GAAG,KAAK,IAAI,KAAK;QAEjD,iBAAiB;QACjB,MAAM,OAAO,GAAG,CAAC,MAAM,CAAC;YACtB,OAAO;gBAAE;YAAM;YACf,QAAQ;gBACN;gBACA;gBACA;YACF;YACA,QAAQ;gBACN;gBACA;gBACA;gBACA;YACF;QACF;QAEA,yBAAyB;QACzB,MAAM,aAAa;YACjB,IAAI;YACJ,KAAK;QACP;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;IAE3C,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,oBAAoB;QAClC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAe,GACxB;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}