{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/app/api/cashfree/webhook/route.js"],"sourcesContent":["export const dynamic = \"force-dynamic\";\r\nexport const runtime = \"nodejs\";\r\n\r\nimport { NextResponse } from \"next/server\";\r\n\r\nexport async function POST(req) {\r\n  try {\r\n    const { default: prisma } = await import(\"@/lib/prisma\");\r\n    const body = await req.json();\r\n\r\n    console.log(\"CASHFREE WEBHOOK RAW:\", body);\r\n\r\n    // Cashfree sends event types as string like:\r\n    // \"subscription.status.changed\"\r\n    // \"subscription.payment.success\"\r\n    // \"subscription.payment.failed\"\r\n    // \"subscription.authorization.completed\"\r\n    \r\n    const event = body.event;\r\n    const data = body.data; // PG Subscriptions uses \"data\", not \"content\"\r\n\r\n    // Accept Cashfree test webhook\r\nif (event === \"PING\" || event === \"ping\") {\r\n  return NextResponse.json({ message: \"pong\" }, { status: 200 });\r\n}\r\n\r\n    if (!event || !data) {\r\n      return NextResponse.json({ error: \"Invalid webhook format\" }, { status: 400 });\r\n    }\r\n\r\n    const cashfreeSubId = data.subscription_id;\r\n    const mandateId = data.mandate_id || data?.upi_si_details?.umrn;\r\n\r\n    // Check subscription\r\n    const subscription = await prisma.subscription.findFirst({\r\n      where: { cashfreeSubscriptionId: cashfreeSubId }\r\n    });\r\n\r\n    if (!subscription) {\r\n      return NextResponse.json({ error: \"Subscription not found\" }, { status: 404 });\r\n    }\r\n\r\n    console.log(\"MATCHED SUB:\", subscription.id);\r\n\r\n    // -------------------------------------------------------------\r\n    // 1️⃣ Mandate Authorization Completed\r\n    // -------------------------------------------------------------\r\n    if (event === \"subscription.authorization.completed\") {\r\n      await prisma.subscription.update({\r\n        where: { id: subscription.id },\r\n        data: {\r\n          cashfreeMandateId: mandateId,\r\n          status: \"pending\"\r\n        }\r\n      });\r\n    }\r\n\r\n    // -------------------------------------------------------------\r\n    // 2️⃣ Subscription Status Changed\r\n    // -------------------------------------------------------------\r\n    if (event === \"subscription.status.changed\") {\r\n      \r\n      if (data.status === \"ACTIVE\") {\r\n        await prisma.subscription.update({\r\n          where: { id: subscription.id },\r\n          data: {\r\n            status: \"active\",\r\n            nextBillingAt: new Date(data.next_billing_at),\r\n            cashfreeMandateId: mandateId || subscription.cashfreeMandateId\r\n          }\r\n        });\r\n      }\r\n\r\n      if (data.status === \"CANCELLED\") {\r\n        await prisma.subscription.update({\r\n          where: { id: subscription.id },\r\n          data: { status: \"cancelled\" }\r\n        });\r\n      }\r\n    }\r\n\r\n    // -------------------------------------------------------------\r\n    // 3️⃣ Payment Success (AutoPay)\r\n    // -------------------------------------------------------------\r\n    if (event === \"subscription.payment.success\") {\r\n      await prisma.subscription.update({\r\n        where: { id: subscription.id },\r\n        data: {\r\n          nextBillingAt: new Date(data.next_billing_at)\r\n        }\r\n      });\r\n\r\n      await prisma.payment.create({\r\n        data: {\r\n          shopId: subscription.shopId,\r\n          subscriptionId: subscription.id,\r\n          amount: data.amount,\r\n          currency: \"INR\",\r\n          status: \"success\",\r\n          method: \"UPI\"\r\n        }\r\n      });\r\n    }\r\n\r\n    // -------------------------------------------------------------\r\n    // 4️⃣ Payment Failed\r\n    // -------------------------------------------------------------\r\n    if (event === \"subscription.payment.failed\") {\r\n      await prisma.payment.create({\r\n        data: {\r\n          shopId: subscription.shopId,\r\n          subscriptionId: subscription.id,\r\n          amount: data.amount,\r\n          currency: \"INR\",\r\n          status: \"failed\",\r\n          method: \"UPI\"\r\n        }\r\n      });\r\n    }\r\n\r\n    return NextResponse.json({ success: true });\r\n\r\n  } catch (err) {\r\n    console.error(\"WEBHOOK ERROR:\", err);\r\n    return NextResponse.json({ error: \"Server error\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}