{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/app/api/shop/user/updateUserDetails/route.js"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { PrismaClient } from \"@prisma/client\";\r\nimport jwt from \"jsonwebtoken\";\r\nimport bcrypt from \"bcryptjs\"\r\nimport { cookies } from \"next/headers\";\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nexport async function PUT(req) {\r\n    try {\r\n\r\n        // Reads JWT from cookies automatically\r\n        const cookieStore = await cookies();\r\n        const token = cookieStore.get(\"token\")?.value;\r\n\r\n        if (!token) {\r\n            return NextResponse.json(\r\n                { error: \"Not authenticated\" },\r\n                { status: 401 }\r\n            );\r\n        }\r\n\r\n        // Verify token\r\n        let decoded\r\n        try {\r\n            decoded = jwt.verify(token, process.env.JWT_SECRET);\r\n        } catch {\r\n            return NextResponse.json({ error: \"Invalid token\" }, { status: 401 })\r\n        }\r\n\r\n\r\n        // ✅ Parse request body\r\n        const body = await req.json();\r\n        const { name, currentPassword, newPassword } = body;\r\n\r\n        if (!name && !newPassword) {\r\n            return NextResponse.json({ error: \"No fields to update\" }, { status: 400 });\r\n        }\r\n\r\n        // ✅ Get user\r\n        const user = await prisma.user.findUnique({\r\n            where: { email: decoded.email },\r\n        });\r\n\r\n        if (!user) {\r\n            return NextResponse.json({ error: \"User not found\" }, { status: 404 });\r\n        }\r\n\r\n        const updateData = {};\r\n\r\n        // ✅ Handle password change\r\n        if (newPassword) {\r\n            if (!currentPassword) {\r\n                return NextResponse.json(\r\n                    { error: \"Current password is required\" },\r\n                    { status: 400 }\r\n                );\r\n            }\r\n\r\n            const isMatch = await bcrypt.compare(currentPassword, user.password);\r\n            if (!isMatch) {\r\n                return NextResponse.json(\r\n                    { error: \"Current password is incorrect\" },\r\n                    { status: 400 }\r\n                );\r\n            }\r\n\r\n            const hashedPassword = await bcrypt.hash(newPassword, 10);\r\n            updateData.password = hashedPassword;\r\n        }\r\n\r\n        // ✅ Handle other updates\r\n        if (name) updateData.name = name;\r\n\r\n        // ✅ Only now update once\r\n        const updatedUser = await prisma.user.update({\r\n            where: { email: decoded.email },\r\n            data: updateData,\r\n        });\r\n\r\n        return NextResponse.json({\r\n            message: newPassword\r\n                ? \"Password and profile updated successfully\"\r\n                : \"Profile updated successfully\",\r\n            user: updatedUser,\r\n        });\r\n    } catch (err) {\r\n        console.error(\"Error updating profile:\", err);\r\n        return NextResponse.json({ error: \"Internal server error\" }, { status: 500 });\r\n    }\r\n}"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAEA,MAAM,SAAS,IAAI,6IAAY;AAExB,eAAe,IAAI,GAAG;IACzB,IAAI;QAEA,uCAAuC;QACvC,MAAM,cAAc,MAAM,IAAA,4IAAO;QACjC,MAAM,QAAQ,YAAY,GAAG,CAAC,UAAU;QAExC,IAAI,CAAC,OAAO;YACR,OAAO,gJAAY,CAAC,IAAI,CACpB;gBAAE,OAAO;YAAoB,GAC7B;gBAAE,QAAQ;YAAI;QAEtB;QAEA,eAAe;QACf,IAAI;QACJ,IAAI;YACA,UAAU,kJAAG,CAAC,MAAM,CAAC,OAAO,QAAQ,GAAG,CAAC,UAAU;QACtD,EAAE,OAAM;YACJ,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAgB,GAAG;gBAAE,QAAQ;YAAI;QACvE;QAGA,uBAAuB;QACvB,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,IAAI,EAAE,eAAe,EAAE,WAAW,EAAE,GAAG;QAE/C,IAAI,CAAC,QAAQ,CAAC,aAAa;YACvB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAsB,GAAG;gBAAE,QAAQ;YAAI;QAC7E;QAEA,aAAa;QACb,MAAM,OAAO,MAAM,OAAO,IAAI,CAAC,UAAU,CAAC;YACtC,OAAO;gBAAE,OAAO,QAAQ,KAAK;YAAC;QAClC;QAEA,IAAI,CAAC,MAAM;YACP,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACxE;QAEA,MAAM,aAAa,CAAC;QAEpB,2BAA2B;QAC3B,IAAI,aAAa;YACb,IAAI,CAAC,iBAAiB;gBAClB,OAAO,gJAAY,CAAC,IAAI,CACpB;oBAAE,OAAO;gBAA+B,GACxC;oBAAE,QAAQ;gBAAI;YAEtB;YAEA,MAAM,UAAU,MAAM,8IAAM,CAAC,OAAO,CAAC,iBAAiB,KAAK,QAAQ;YACnE,IAAI,CAAC,SAAS;gBACV,OAAO,gJAAY,CAAC,IAAI,CACpB;oBAAE,OAAO;gBAAgC,GACzC;oBAAE,QAAQ;gBAAI;YAEtB;YAEA,MAAM,iBAAiB,MAAM,8IAAM,CAAC,IAAI,CAAC,aAAa;YACtD,WAAW,QAAQ,GAAG;QAC1B;QAEA,yBAAyB;QACzB,IAAI,MAAM,WAAW,IAAI,GAAG;QAE5B,yBAAyB;QACzB,MAAM,cAAc,MAAM,OAAO,IAAI,CAAC,MAAM,CAAC;YACzC,OAAO;gBAAE,OAAO,QAAQ,KAAK;YAAC;YAC9B,MAAM;QACV;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACrB,SAAS,cACH,8CACA;YACN,MAAM;QACV;IACJ,EAAE,OAAO,KAAK;QACV,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC/E;AACJ"}}]
}