{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/app/api/shop/paymentVerification/manualVerify/route.js"],"sourcesContent":["export const dynamic = \"force-dynamic\";\r\nexport const runtime = \"nodejs\";\r\n\r\nimport { NextResponse } from \"next/server\";\r\nimport { nanoid } from \"nanoid\"\r\n\r\nexport async function POST(req) {\r\n    try {\r\n        const { default: prisma } = await import(\"@/lib/prisma\");\r\n\r\n        const body = await req.json();\r\n        const { scanId, shopId } = body;\r\n        \r\n\r\n        if (!shopId && !scanId) {\r\n            return NextResponse.json(\r\n                { error: \"Inavalid\" },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // -------------------------\r\n        // UPDATE\r\n        // -------------------------\r\n        const scan = await prisma.scanVerification.update({\r\n            where: { id: scanId },\r\n            data: {\r\n                status: 'success',\r\n                verifiedAt: new Date(),\r\n                rejectReason: null\r\n            }\r\n        });\r\n\r\n\r\n        // FETCH CUSTOMER\r\n        let customer = await prisma.customer.findFirst({\r\n            where: { shopId, phone: scan.phone }\r\n        });\r\n\r\n\r\n        //  3. If no customer → create new one\r\n        if (!customer) {\r\n            customer = await prisma.customer.create({\r\n                data: {\r\n                    id: `cust_${nanoid(10)}`,\r\n                    shopId,\r\n                    phone: scan.phone,\r\n                    stampCount: 1,\r\n                    totalVisits: 1,\r\n                    totalStampCount: 1,\r\n                    lastVisit: new Date(),\r\n                },\r\n            });\r\n        }\r\n        else {\r\n            //  Customer exists → add stamp\r\n            customer = await prisma.customer.update({\r\n                where: { id: customer.id },\r\n                data: {\r\n                    stampCount: { increment: 1 },\r\n                    totalVisits: { increment: 1 },\r\n                    totalStampCount: { increment: 1 },\r\n                    lastVisit: new Date(),\r\n                },\r\n            });\r\n        }\r\n\r\n\r\n        // -------------------------\r\n        // RESPONSE\r\n        // -------------------------\r\n        return NextResponse.json({\r\n            success: true,\r\n            message: \"Scan verified. Stamp added.\",\r\n            data: scan,\r\n        });\r\n\r\n    } catch (err) {\r\n        console.error(\"Scan Verification API error:\", err);\r\n        return NextResponse.json(\r\n            { error: \"Server Error\" },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAGA;AACA;AAJO,MAAM,UAAU;AAChB,MAAM,UAAU;;;AAKhB,eAAe,KAAK,GAAG;IAC1B,IAAI;QACA,MAAM,EAAE,SAAS,MAAM,EAAE,GAAG;QAE5B,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,MAAM,EAAE,MAAM,EAAE,GAAG;QAG3B,IAAI,CAAC,UAAU,CAAC,QAAQ;YACpB,OAAO,gJAAY,CAAC,IAAI,CACpB;gBAAE,OAAO;YAAW,GACpB;gBAAE,QAAQ;YAAI;QAEtB;QAEA,4BAA4B;QAC5B,SAAS;QACT,4BAA4B;QAC5B,MAAM,OAAO,MAAM,OAAO,gBAAgB,CAAC,MAAM,CAAC;YAC9C,OAAO;gBAAE,IAAI;YAAO;YACpB,MAAM;gBACF,QAAQ;gBACR,YAAY,IAAI;gBAChB,cAAc;YAClB;QACJ;QAGA,iBAAiB;QACjB,IAAI,WAAW,MAAM,OAAO,QAAQ,CAAC,SAAS,CAAC;YAC3C,OAAO;gBAAE;gBAAQ,OAAO,KAAK,KAAK;YAAC;QACvC;QAGA,sCAAsC;QACtC,IAAI,CAAC,UAAU;YACX,WAAW,MAAM,OAAO,QAAQ,CAAC,MAAM,CAAC;gBACpC,MAAM;oBACF,IAAI,CAAC,KAAK,EAAE,IAAA,2JAAM,EAAC,KAAK;oBACxB;oBACA,OAAO,KAAK,KAAK;oBACjB,YAAY;oBACZ,aAAa;oBACb,iBAAiB;oBACjB,WAAW,IAAI;gBACnB;YACJ;QACJ,OACK;YACD,+BAA+B;YAC/B,WAAW,MAAM,OAAO,QAAQ,CAAC,MAAM,CAAC;gBACpC,OAAO;oBAAE,IAAI,SAAS,EAAE;gBAAC;gBACzB,MAAM;oBACF,YAAY;wBAAE,WAAW;oBAAE;oBAC3B,aAAa;wBAAE,WAAW;oBAAE;oBAC5B,iBAAiB;wBAAE,WAAW;oBAAE;oBAChC,WAAW,IAAI;gBACnB;YACJ;QACJ;QAGA,4BAA4B;QAC5B,WAAW;QACX,4BAA4B;QAC5B,OAAO,gJAAY,CAAC,IAAI,CAAC;YACrB,SAAS;YACT,SAAS;YACT,MAAM;QACV;IAEJ,EAAE,OAAO,KAAK;QACV,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,OAAO,gJAAY,CAAC,IAAI,CACpB;YAAE,OAAO;QAAe,GACxB;YAAE,QAAQ;QAAI;IAEtB;AACJ"}}]
}