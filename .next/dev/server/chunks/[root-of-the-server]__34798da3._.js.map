{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/app/api/shop/dashboardStats/route.js"],"sourcesContent":["export const dynamic = \"force-dynamic\";\r\nexport const runtime = \"nodejs\";\r\n\r\nimport { NextResponse } from \"next/server\";\r\n\r\n// Convert UTC ‚Üí IST\r\nfunction toIST(date) {\r\n    const d = new Date(date);\r\n    const utc = d.getTime() + d.getTimezoneOffset() * 60000;\r\n    return new Date(utc + 5.5 * 60 * 60 * 1000);\r\n}\r\n\r\nexport async function POST(req) {\r\n    try {\r\n        const { default: prisma } = await import(\"@/lib/prisma\");\r\n\r\n        const body = await req.json();\r\n        const { shopId } = body;\r\n\r\n        if (!shopId) {\r\n            return NextResponse.json(\r\n                { error: \"Shop ID is required\" },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        /* ---------------------------------------------\r\n           üìå Generate correct IST month boundaries\r\n        ---------------------------------------------- */\r\n        const nowIST = toIST(new Date());\r\n\r\n        const monthStartIST = new Date(\r\n            nowIST.getFullYear(),\r\n            nowIST.getMonth(),\r\n            1\r\n        );\r\n\r\n        const nextMonthIST = new Date(\r\n            nowIST.getFullYear(),\r\n            nowIST.getMonth() + 1,\r\n            1\r\n        );\r\n\r\n        /* ---------------------------------------------\r\n           1Ô∏è‚É£ Revenue (This IST Month)\r\n        ---------------------------------------------- */\r\n        const revenueData = await prisma.scanVerification.aggregate({\r\n            where: {\r\n                shopId,\r\n                status: 'success',\r\n                createdAt: {\r\n                    gte: monthStartIST,\r\n                    lt: nextMonthIST\r\n                }\r\n            },\r\n            _sum: { amount: true },\r\n            _count: { id: true },\r\n        });\r\n\r\n        const revenue = revenueData._sum.amount || 0;\r\n\r\n        /* ---------------------------------------------\r\n          2Ô∏è‚É£ Stamps Given (This IST Month)\r\n       ---------------------------------------------- */\r\n        const stampsGiven = revenueData._count.id || 0;\r\n\r\n        /* ---------------------------------------------\r\n           3Ô∏è‚É£ Rewards Redeemed (This IST Month)\r\n        ---------------------------------------------- */\r\n        const rewardsRedeemed = await prisma.reward.count({\r\n            where: {\r\n                shopId,\r\n                createdAt: {\r\n                    gte: monthStartIST,\r\n                    lt: nextMonthIST\r\n                }\r\n            }\r\n        });\r\n\r\n        /* ---------------------------------------------\r\n           4Ô∏è‚É£ Repeat Customer Rate (IST Month)\r\n        ---------------------------------------------- */\r\n        const visits = await prisma.scanVerification.groupBy({\r\n            by: [\"customerId\"],\r\n            where: {\r\n                shopId,\r\n                status: 'success',\r\n                createdAt: {\r\n                    gte: monthStartIST,\r\n                    lt: nextMonthIST\r\n                }\r\n            },\r\n            _count: { id: true }\r\n        });\r\n\r\n        const allVisitors = visits.length;\r\n        const returning = visits.filter(v => v._count.id > 1).length;\r\n\r\n        const repeatRate =\r\n            allVisitors > 0\r\n                ? Math.round((returning / allVisitors) * 100)\r\n                : 0;\r\n\r\n        /* ---------------------------------------------\r\n           5Ô∏è‚É£ Best Customers (Lifetime)\r\n        ---------------------------------------------- */\r\n        const bestCustomers = await prisma.customer.findMany({\r\n            where: { shopId },\r\n            orderBy: { totalStampCount: \"desc\" },\r\n            take: 5\r\n        });\r\n\r\n        /* ---------------------------------------------\r\n           6Ô∏è‚É£ Close To Reward\r\n        ---------------------------------------------- */\r\n        const shop = await prisma.shop.findUnique({\r\n            where: { id: shopId },\r\n            select: { targetStamps: true }\r\n        });\r\n\r\n        const target = shop?.targetStamps || 0;\r\n\r\n        const closeToReward = await prisma.customer.findMany({\r\n            where: {\r\n                shopId,\r\n                stampCount: {\r\n                    gte: Number(target) - 4,\r\n                    lt: Number(target)\r\n                }\r\n            },\r\n            take: 5\r\n        });\r\n\r\n        return NextResponse.json({\r\n            revenue,\r\n            stampsGiven,\r\n            rewardsRedeemed,\r\n            repeatRate,\r\n            bestCustomers,\r\n            closeToReward,\r\n            monthStartIST,\r\n            nextMonthIST\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error(\"Dashboard Stats Error:\", error);\r\n        return NextResponse.json(\r\n            { error: error.message || \"Something went wrong\" },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAGA;AAHO,MAAM,UAAU;AAChB,MAAM,UAAU;;AAIvB,oBAAoB;AACpB,SAAS,MAAM,IAAI;IACf,MAAM,IAAI,IAAI,KAAK;IACnB,MAAM,MAAM,EAAE,OAAO,KAAK,EAAE,iBAAiB,KAAK;IAClD,OAAO,IAAI,KAAK,MAAM,MAAM,KAAK,KAAK;AAC1C;AAEO,eAAe,KAAK,GAAG;IAC1B,IAAI;QACA,MAAM,EAAE,SAAS,MAAM,EAAE,GAAG;QAE5B,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,MAAM,EAAE,GAAG;QAEnB,IAAI,CAAC,QAAQ;YACT,OAAO,gJAAY,CAAC,IAAI,CACpB;gBAAE,OAAO;YAAsB,GAC/B;gBAAE,QAAQ;YAAI;QAEtB;QAEA;;uDAE+C,GAC/C,MAAM,SAAS,MAAM,IAAI;QAEzB,MAAM,gBAAgB,IAAI,KACtB,OAAO,WAAW,IAClB,OAAO,QAAQ,IACf;QAGJ,MAAM,eAAe,IAAI,KACrB,OAAO,WAAW,IAClB,OAAO,QAAQ,KAAK,GACpB;QAGJ;;uDAE+C,GAC/C,MAAM,cAAc,MAAM,OAAO,gBAAgB,CAAC,SAAS,CAAC;YACxD,OAAO;gBACH;gBACA,QAAQ;gBACR,WAAW;oBACP,KAAK;oBACL,IAAI;gBACR;YACJ;YACA,MAAM;gBAAE,QAAQ;YAAK;YACrB,QAAQ;gBAAE,IAAI;YAAK;QACvB;QAEA,MAAM,UAAU,YAAY,IAAI,CAAC,MAAM,IAAI;QAE3C;;sDAE8C,GAC9C,MAAM,cAAc,YAAY,MAAM,CAAC,EAAE,IAAI;QAE7C;;uDAE+C,GAC/C,MAAM,kBAAkB,MAAM,OAAO,MAAM,CAAC,KAAK,CAAC;YAC9C,OAAO;gBACH;gBACA,WAAW;oBACP,KAAK;oBACL,IAAI;gBACR;YACJ;QACJ;QAEA;;uDAE+C,GAC/C,MAAM,SAAS,MAAM,OAAO,gBAAgB,CAAC,OAAO,CAAC;YACjD,IAAI;gBAAC;aAAa;YAClB,OAAO;gBACH;gBACA,QAAQ;gBACR,WAAW;oBACP,KAAK;oBACL,IAAI;gBACR;YACJ;YACA,QAAQ;gBAAE,IAAI;YAAK;QACvB;QAEA,MAAM,cAAc,OAAO,MAAM;QACjC,MAAM,YAAY,OAAO,MAAM,CAAC,CAAA,IAAK,EAAE,MAAM,CAAC,EAAE,GAAG,GAAG,MAAM;QAE5D,MAAM,aACF,cAAc,IACR,KAAK,KAAK,CAAC,AAAC,YAAY,cAAe,OACvC;QAEV;;uDAE+C,GAC/C,MAAM,gBAAgB,MAAM,OAAO,QAAQ,CAAC,QAAQ,CAAC;YACjD,OAAO;gBAAE;YAAO;YAChB,SAAS;gBAAE,iBAAiB;YAAO;YACnC,MAAM;QACV;QAEA;;uDAE+C,GAC/C,MAAM,OAAO,MAAM,OAAO,IAAI,CAAC,UAAU,CAAC;YACtC,OAAO;gBAAE,IAAI;YAAO;YACpB,QAAQ;gBAAE,cAAc;YAAK;QACjC;QAEA,MAAM,SAAS,MAAM,gBAAgB;QAErC,MAAM,gBAAgB,MAAM,OAAO,QAAQ,CAAC,QAAQ,CAAC;YACjD,OAAO;gBACH;gBACA,YAAY;oBACR,KAAK,OAAO,UAAU;oBACtB,IAAI,OAAO;gBACf;YACJ;YACA,MAAM;QACV;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACrB;YACA;YACA;YACA;YACA;YACA;YACA;YACA;QACJ;IAEJ,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,0BAA0B;QACxC,OAAO,gJAAY,CAAC,IAAI,CACpB;YAAE,OAAO,MAAM,OAAO,IAAI;QAAuB,GACjD;YAAE,QAAQ;QAAI;IAEtB;AACJ"}}]
}