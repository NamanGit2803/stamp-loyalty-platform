{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/app/api/shop/customers/rewardRedeem/route.js"],"sourcesContent":["\r\nexport const dynamic = \"force-dynamic\";\r\nexport const runtime = \"nodejs\";\r\n\r\nimport { NextResponse } from \"next/server\";\r\nimport { nanoid } from \"nanoid\"\r\n\r\nexport async function POST(req) {\r\n    try {\r\n        const { default: prisma } = await import(\"@/lib/prisma\");\r\n\r\n        const body = await req.json();\r\n        const { customerId, shopId, requiredStamps = 10, rewardText } = body;\r\n\r\n        if (!customerId || !shopId) {\r\n            return NextResponse.json(\r\n                { error: \"CustomerId and shopId are required.\" },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // FETCH CUSTOMER\r\n        const customer = await prisma.customer.findUnique({\r\n            where: { id: customerId }\r\n        });\r\n\r\n        if (!customer) {\r\n            return NextResponse.json(\r\n                { error: \"Customer not found\" },\r\n                { status: 404 }\r\n            );\r\n        }\r\n\r\n        // CHECK IF ENOUGH STAMPS\r\n        if (customer.stampCount < requiredStamps) {\r\n            return NextResponse.json(\r\n                { error: \"Not enough stamps to redeem\" },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // DEDUCT STAMPS\r\n        const updated = await prisma.customer.update({\r\n            where: { id: customerId },\r\n            data: {\r\n                stampCount: customer.stampCount - requiredStamps,\r\n                lastVisit: new Date()\r\n            }\r\n        });\r\n\r\n\r\n        // make reward entry \r\n        const reward = await prisma.reward.create({\r\n            data: {\r\n                id: `reward_${nanoid(8)}`,        \r\n                shopId,\r\n                customerId,\r\n                rewardText,\r\n            },\r\n        });\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            message: \"Reward redeemed successfully!\",\r\n            data: updated\r\n        });\r\n\r\n    } catch (err) {\r\n        console.error(\"Redeem API Error:\", err);\r\n        return NextResponse.json(\r\n            { error: \"Server Error\" },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAIA;AACA;AAJO,MAAM,UAAU;AAChB,MAAM,UAAU;;;AAKhB,eAAe,KAAK,GAAG;IAC1B,IAAI;QACA,MAAM,EAAE,SAAS,MAAM,EAAE,GAAG;QAE5B,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,UAAU,EAAE,MAAM,EAAE,iBAAiB,EAAE,EAAE,UAAU,EAAE,GAAG;QAEhE,IAAI,CAAC,cAAc,CAAC,QAAQ;YACxB,OAAO,gJAAY,CAAC,IAAI,CACpB;gBAAE,OAAO;YAAsC,GAC/C;gBAAE,QAAQ;YAAI;QAEtB;QAEA,iBAAiB;QACjB,MAAM,WAAW,MAAM,OAAO,QAAQ,CAAC,UAAU,CAAC;YAC9C,OAAO;gBAAE,IAAI;YAAW;QAC5B;QAEA,IAAI,CAAC,UAAU;YACX,OAAO,gJAAY,CAAC,IAAI,CACpB;gBAAE,OAAO;YAAqB,GAC9B;gBAAE,QAAQ;YAAI;QAEtB;QAEA,yBAAyB;QACzB,IAAI,SAAS,UAAU,GAAG,gBAAgB;YACtC,OAAO,gJAAY,CAAC,IAAI,CACpB;gBAAE,OAAO;YAA8B,GACvC;gBAAE,QAAQ;YAAI;QAEtB;QAEA,gBAAgB;QAChB,MAAM,UAAU,MAAM,OAAO,QAAQ,CAAC,MAAM,CAAC;YACzC,OAAO;gBAAE,IAAI;YAAW;YACxB,MAAM;gBACF,YAAY,SAAS,UAAU,GAAG;gBAClC,WAAW,IAAI;YACnB;QACJ;QAGA,qBAAqB;QACrB,MAAM,SAAS,MAAM,OAAO,MAAM,CAAC,MAAM,CAAC;YACtC,MAAM;gBACF,IAAI,CAAC,OAAO,EAAE,IAAA,2JAAM,EAAC,IAAI;gBACzB;gBACA;gBACA;YACJ;QACJ;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACrB,SAAS;YACT,SAAS;YACT,MAAM;QACV;IAEJ,EAAE,OAAO,KAAK;QACV,QAAQ,KAAK,CAAC,qBAAqB;QACnC,OAAO,gJAAY,CAAC,IAAI,CACpB;YAAE,OAAO;QAAe,GACxB;YAAE,QAAQ;QAAI;IAEtB;AACJ"}}]
}