{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/app/api/auth/forgotPassword/resetPassword/route.js"],"sourcesContent":["export const dynamic = \"force-dynamic\";\r\nexport const runtime = \"nodejs\";\r\n\r\nimport { NextResponse } from \"next/server\";\r\nimport crypto from \"crypto\";\r\nimport bcrypt from \"bcryptjs\";\r\n\r\nexport async function POST(req) {\r\n    try {\r\n        // lazy prisma import (build-safe)\r\n        const { default: prisma } = await import(\"@/lib/prisma\");\r\n\r\n        const body = await req.json();\r\n        const { token, password } = body;\r\n\r\n\r\n        // Validation\r\n        if (!token || !password) {\r\n            return NextResponse.json(\r\n                { error: \"Token and new password are required\" },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // hash incoming token to match stored one\r\n        const tokenHash = crypto\r\n            .createHash(\"sha256\")\r\n            .update(token)\r\n            .digest(\"hex\");\r\n\r\n        // find reset token\r\n        const reset = await prisma.passwordReset.findUnique({\r\n            where: { tokenHash },\r\n        });\r\n\r\n\r\n        if (!reset) {\r\n            return NextResponse.json(\r\n                { error: \"Invalid or expired token\" },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n\r\n\r\n        // check expiry\r\n        if (reset.expiresAt.getTime() < Date.now()) {\r\n            return NextResponse.json(\r\n                { error: \"Reset link has expired\" },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // find user with email\r\n        const user = await prisma.user.findUnique({\r\n            where: { email: reset.userId },\r\n        });\r\n\r\n        if (!user) {\r\n            return NextResponse.json(\r\n                { error: \"User not found\" },\r\n                { status: 404 }\r\n            );\r\n        }\r\n\r\n        // hash new password with bcrypt\r\n        const hashedPassword = await bcrypt.hash(password, 10);\r\n\r\n        // update password\r\n        await prisma.user.update({\r\n            where: { email: reset.userId },\r\n            data: { password: hashedPassword },\r\n        });\r\n\r\n        // delete ALL reset tokens for this email\r\n        await prisma.passwordReset.deleteMany({\r\n            where: { userId: reset.userId },\r\n        });\r\n\r\n        return NextResponse.json(\r\n            {\r\n                success: true,\r\n                message: \"Password has been reset successfully.\",\r\n            },\r\n            { status: 200 }\r\n        );\r\n    } catch (err) {\r\n        console.error(\"[reset password error]\", err);\r\n        return NextResponse.json(\r\n            { error: \"Server error\" },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAGA;AACA;AACA;AALO,MAAM,UAAU;AAChB,MAAM,UAAU;;;;AAMhB,eAAe,KAAK,GAAG;IAC1B,IAAI;QACA,kCAAkC;QAClC,MAAM,EAAE,SAAS,MAAM,EAAE,GAAG;QAE5B,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG;QAG5B,aAAa;QACb,IAAI,CAAC,SAAS,CAAC,UAAU;YACrB,OAAO,gJAAY,CAAC,IAAI,CACpB;gBAAE,OAAO;YAAsC,GAC/C;gBAAE,QAAQ;YAAI;QAEtB;QAEA,0CAA0C;QAC1C,MAAM,YAAY,gHAAM,CACnB,UAAU,CAAC,UACX,MAAM,CAAC,OACP,MAAM,CAAC;QAEZ,mBAAmB;QACnB,MAAM,QAAQ,MAAM,OAAO,aAAa,CAAC,UAAU,CAAC;YAChD,OAAO;gBAAE;YAAU;QACvB;QAGA,IAAI,CAAC,OAAO;YACR,OAAO,gJAAY,CAAC,IAAI,CACpB;gBAAE,OAAO;YAA2B,GACpC;gBAAE,QAAQ;YAAI;QAEtB;QAIA,eAAe;QACf,IAAI,MAAM,SAAS,CAAC,OAAO,KAAK,KAAK,GAAG,IAAI;YACxC,OAAO,gJAAY,CAAC,IAAI,CACpB;gBAAE,OAAO;YAAyB,GAClC;gBAAE,QAAQ;YAAI;QAEtB;QAEA,uBAAuB;QACvB,MAAM,OAAO,MAAM,OAAO,IAAI,CAAC,UAAU,CAAC;YACtC,OAAO;gBAAE,OAAO,MAAM,MAAM;YAAC;QACjC;QAEA,IAAI,CAAC,MAAM;YACP,OAAO,gJAAY,CAAC,IAAI,CACpB;gBAAE,OAAO;YAAiB,GAC1B;gBAAE,QAAQ;YAAI;QAEtB;QAEA,gCAAgC;QAChC,MAAM,iBAAiB,MAAM,8IAAM,CAAC,IAAI,CAAC,UAAU;QAEnD,kBAAkB;QAClB,MAAM,OAAO,IAAI,CAAC,MAAM,CAAC;YACrB,OAAO;gBAAE,OAAO,MAAM,MAAM;YAAC;YAC7B,MAAM;gBAAE,UAAU;YAAe;QACrC;QAEA,yCAAyC;QACzC,MAAM,OAAO,aAAa,CAAC,UAAU,CAAC;YAClC,OAAO;gBAAE,QAAQ,MAAM,MAAM;YAAC;QAClC;QAEA,OAAO,gJAAY,CAAC,IAAI,CACpB;YACI,SAAS;YACT,SAAS;QACb,GACA;YAAE,QAAQ;QAAI;IAEtB,EAAE,OAAO,KAAK;QACV,QAAQ,KAAK,CAAC,0BAA0B;QACxC,OAAO,gJAAY,CAAC,IAAI,CACpB;YAAE,OAAO;QAAe,GACxB;YAAE,QAAQ;QAAI;IAEtB;AACJ"}}]
}