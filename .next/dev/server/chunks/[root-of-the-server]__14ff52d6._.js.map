{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/app/api/screenshot/verify/route.js"],"sourcesContent":["export const runtime = \"nodejs\";\r\n\r\nimport { NextResponse } from \"next/server\";\r\nimport crypto from \"crypto\";\r\nimport { PrismaClient } from \"@prisma/client\";\r\nimport { parsePaymentScreenshot } from \"@/lib/parsePaymentScreenshot\";\r\n\r\nconst prisma = new PrismaClient();\r\n\r\n/* ------------------------------\r\n   üîê SHA256 HASH\r\n--------------------------------*/\r\nfunction sha256(buffer) {\r\n    return crypto.createHash(\"sha256\").update(buffer).digest(\"hex\");\r\n}\r\n\r\nexport async function POST(req) {\r\n    try {\r\n        const formData = await req.formData();\r\n\r\n        const file = formData.get(\"file\");\r\n        const shopId = formData.get(\"shopId\");\r\n        const phone = formData.get(\"phone\");\r\n\r\n        if (!file || !shopId || !phone) {\r\n            return NextResponse.json(\r\n                { error: \"Missing required fields\" },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        if (phone.length < 10) {\r\n            return NextResponse.json(\r\n                { error: \"Invalid phone number\" },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        /* ------------------------------\r\n           1Ô∏è‚É£ READ IMAGE\r\n        --------------------------------*/\r\n        const bytes = await file.arrayBuffer();\r\n        const buffer = Buffer.from(bytes);\r\n\r\n        const screenshotHash = sha256(buffer);\r\n        const imageBase64 = buffer.toString(\"base64\");\r\n\r\n        /* ------------------------------\r\n           2Ô∏è‚É£ DEEPSEEK OCR\r\n        --------------------------------*/\r\n        const ai = await parsePaymentScreenshot(imageBase64);\r\n\r\n        console.log(\"üîç DeepSeek OCR ‚Üí\", ai);\r\n\r\n        // üö® HARD SAFETY GATE\r\n        if (\r\n            ai.aiError ||\r\n            ai.confidence < 0.6 ||\r\n            !ai.amount ||\r\n            !ai.utr\r\n        ) {\r\n            return NextResponse.json(\r\n                { success: false, rejectReason: \"ocr_low_confidence\" },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        const {\r\n            amount,\r\n            upiId,\r\n            utr,\r\n            date,\r\n            appDetected,\r\n            isLikelyFake,\r\n        } = ai;\r\n\r\n        /* ------------------------------\r\n           3Ô∏è‚É£ FETCH SHOP\r\n        --------------------------------*/\r\n        const shop = await prisma.shop.findUnique({\r\n            where: { id: shopId },\r\n        });\r\n\r\n        if (!shop) {\r\n            return NextResponse.json(\r\n                { error: \"Invalid shopId\" },\r\n                { status: 404 }\r\n            );\r\n        }\r\n\r\n        /* ------------------------------\r\n           4Ô∏è‚É£ DUPLICATE SCREENSHOT CHECK\r\n        --------------------------------*/\r\n        const duplicateScreenshot = await prisma.scanVerification.findFirst({\r\n            where: { shopId, screenshotHash },\r\n        });\r\n\r\n        if (duplicateScreenshot) {\r\n            return NextResponse.json(\r\n                { success: false, rejectReason: \"duplicate_screenshot\" },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        /* ------------------------------\r\n           5Ô∏è‚É£ CREATE / FETCH CUSTOMER\r\n        --------------------------------*/\r\n        let customer = await prisma.customer.findFirst({\r\n            where: { shopId, phone },\r\n        });\r\n\r\n        if (!customer) {\r\n            customer = await prisma.customer.create({\r\n                data: {\r\n                    id: `cus_${crypto.randomUUID()}`,\r\n                    shopId,\r\n                    phone,\r\n                },\r\n            });\r\n        }\r\n\r\n        /* ------------------------------\r\n           6Ô∏è‚É£ FRAUD & BUSINESS RULES\r\n        --------------------------------*/\r\n        let rejectReason = null;\r\n\r\n        // AI flagged fake\r\n        if (isLikelyFake) {\r\n            rejectReason = \"suspicious_screenshot\";\r\n        }\r\n\r\n        // UPI mismatch\r\n        if (!rejectReason && shop.upiId && upiId && shop.upiId !== upiId) {\r\n            rejectReason = \"upi_mismatch\";\r\n        }\r\n\r\n        // Minimum amount\r\n        if (!rejectReason && amount < Number(shop.minAmount || 0)) {\r\n            rejectReason = \"below_minimum\";\r\n        }\r\n\r\n        // Duplicate UTR\r\n        if (!rejectReason && utr) {\r\n            const utrExists = await prisma.scanVerification.findFirst({\r\n                where: { shopId, utr },\r\n            });\r\n            if (utrExists) rejectReason = \"duplicate_utr\";\r\n        }\r\n\r\n        // Daily limit per customer\r\n        if (!rejectReason) {\r\n            const todayCount = await prisma.scanVerification.count({\r\n                where: {\r\n                    shopId,\r\n                    customerId: customer.id,\r\n                    status: \"success\",\r\n                    createdAt: {\r\n                        gte: new Date(new Date().setHours(0, 0, 0, 0)),\r\n                    },\r\n                },\r\n            });\r\n\r\n            if (todayCount >= shop.maxStampsPerCustomerPerDay) {\r\n                rejectReason = \"daily_limit_reached\";\r\n            }\r\n        }\r\n\r\n        /* ------------------------------\r\n           7Ô∏è‚É£ SAVE VERIFICATION\r\n        --------------------------------*/\r\n        const scan = await prisma.scanVerification.create({\r\n            data: {\r\n                shopId,\r\n                customerId: customer.id,\r\n                amount,\r\n                currency: \"INR\",\r\n                upiId,\r\n                utr,\r\n                paidAt: date ? new Date(date) : new Date(),\r\n                status: rejectReason ? \"rejected\" : \"success\",\r\n                rejectReason,\r\n                screenshotHash,\r\n                appDetected,\r\n                ocrText: null, // ‚ùå no raw OCR stored\r\n            },\r\n        });\r\n\r\n        if (rejectReason) {\r\n            return NextResponse.json(\r\n                { success: false, rejectReason },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        /* ------------------------------\r\n           8Ô∏è‚É£ AWARD STAMP\r\n        --------------------------------*/\r\n        await prisma.customer.update({\r\n            where: { id: customer.id },\r\n            data: {\r\n                stampCount: { increment: 1 },\r\n                totalVisits: { increment: 1 },\r\n                lastVisit: new Date(),\r\n            },\r\n        });\r\n\r\n        /* ------------------------------\r\n           9Ô∏è‚É£ TRANSACTION LOG\r\n        --------------------------------*/\r\n        await prisma.transaction.create({\r\n            data: {\r\n                id: `txn_${crypto.randomUUID()}`,\r\n                shopId,\r\n                customerId: customer.id,\r\n                amount,\r\n                status: \"success\",\r\n                upiId,\r\n                method: \"UPI_SCREENSHOT\",\r\n            },\r\n        });\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            message: \"Stamp added!\",\r\n            scanId: scan.id,\r\n        });\r\n    } catch (err) {\r\n        console.error(\"VERIFY ERROR ‚Üí\", err);\r\n        return NextResponse.json(\r\n            { error: \"Server error\" },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}