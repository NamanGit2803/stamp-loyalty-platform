{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/app/api/screenshot/verify/route.js"],"sourcesContent":["export const runtime = \"nodejs\";\r\n\r\nimport { NextResponse } from \"next/server\";\r\nimport crypto from \"crypto\";\r\nimport { PrismaClient } from \"@prisma/client\";\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nfunction sha256(buffer) {\r\n    return crypto.createHash(\"sha256\").update(buffer).digest(\"hex\");\r\n}\r\n\r\nexport async function POST(req) {\r\n    try {\r\n        const formData = await req.formData();\r\n        const file = formData.get(\"file\");\r\n        const shopId = formData.get(\"shopId\");\r\n        const phone = formData.get(\"phone\");\r\n        const ocrJson = formData.get(\"ocrResult\");\r\n\r\n        \r\n\r\n        if (!file || !shopId || !ocrJson || !phone) {\r\n            return NextResponse.json({ error: \"Missing required fields\" }, { status: 400 });\r\n        }\r\n\r\n        const ocr = JSON.parse(ocrJson);\r\n        console.log('ocr', ocr)\r\n        const { text, amount, upiId, utr, status: paymentStatus, appDetected } = ocr;\r\n\r\n        // --------------------------------------\r\n        //   1️⃣ HASH ORIGINAL IMAGE (TRUE DUPLICATE CHECK)\r\n        // --------------------------------------\r\n        const bytes = await file.arrayBuffer();\r\n        const buffer = Buffer.from(bytes);\r\n        const screenshotHash = sha256(buffer);\r\n\r\n        // --------------------------------------\r\n        //   2️⃣ FETCH SHOP\r\n        // --------------------------------------\r\n        const shop = await prisma.shop.findUnique({ where: { id: shopId } });\r\n        if (!shop) return NextResponse.json({ error: \"Invalid shopId\" }, { status: 404 });\r\n\r\n\r\n        // --------------------------------------\r\n        //   3️⃣ VERIFY DUPLICATE SCREENSHOT\r\n        // --------------------------------------\r\n        const existing = await prisma.scanVerification.findFirst({\r\n            where: { shopId, screenshotHash }\r\n        });\r\n\r\n        if (existing) {\r\n            return NextResponse.json({\r\n                success: false,\r\n                rejectReason: \"duplicate_screenshot\"\r\n            }, { status: 400 });\r\n        }\r\n\r\n        // --------------------------------------\r\n        //   4️⃣ CREATE OR FETCH CUSTOMER\r\n        // --------------------------------------\r\n        let customer = await prisma.customer.findFirst({ where: { shopId, phone } });\r\n\r\n        if (!customer) {\r\n            customer = await prisma.customer.create({\r\n                data: {\r\n                    id: `cus_${crypto.randomUUID()}`,\r\n                    shopId,\r\n                    phone\r\n                }\r\n            });\r\n        }\r\n\r\n        // --------------------------------------\r\n        //   5️⃣ FRAUD CHECKS\r\n        // --------------------------------------\r\n        let rejectReason = null;\r\n\r\n\r\n        if (shop.upiId && upiId && shop.upiId !== upiId) {\r\n            rejectReason = \"upi_mismatch\";\r\n        }\r\n\r\n        if (!rejectReason && amount < Number(shop.minAmount || 0)) {\r\n            rejectReason = \"below_minimum\";\r\n        }\r\n\r\n        if (!rejectReason && paymentStatus !== \"success\") {\r\n            rejectReason = \"payment_not_success\";\r\n        }\r\n\r\n        if (!rejectReason && utr) {\r\n            const utrExists = await prisma.scanVerification.findFirst({\r\n                where: { shopId, utr }\r\n            });\r\n            if (utrExists) rejectReason = \"duplicate_utr\";\r\n        }\r\n\r\n        if (amount === null || isNaN(amount)) {\r\n            return NextResponse.json({\r\n                success: false,\r\n                rejectReason: \"ocr_failed_amount\"\r\n            }, { status: 400 });\r\n        }\r\n\r\n\r\n        // per day limits\r\n        if (!rejectReason) {\r\n            const todayCount = await prisma.scanVerification.count({\r\n                where: {\r\n                    shopId,\r\n                    customerId: customer.id,\r\n                    status: \"success\",\r\n                    createdAt: { gte: new Date(new Date().setHours(0, 0, 0, 0)) },\r\n                },\r\n            });\r\n\r\n            if (todayCount >= shop.maxStampsPerCustomerPerDay) {\r\n                rejectReason = \"daily_limit_reached\";\r\n            }\r\n        }\r\n\r\n        // --------------------------------------\r\n        //   6️⃣ SAVE THE VERIFICATION RECORD\r\n        // --------------------------------------\r\n        const scan = await prisma.scanVerification.create({\r\n            data: {\r\n                shopId,\r\n                customerId: customer.id,\r\n                amount,\r\n                currency: \"INR\",\r\n                upiId,\r\n                utr,\r\n                paidAt: new Date(),\r\n                status: rejectReason ? \"rejected\" : \"success\",\r\n                rejectReason,\r\n                screenshotHash,\r\n                appDetected,\r\n                ocrText: text\r\n            }\r\n        });\r\n\r\n        if (rejectReason) {\r\n            return NextResponse.json({\r\n                success: false,\r\n                rejectReason\r\n            }, { status: 400 });\r\n        }\r\n\r\n        // --------------------------------------\r\n        //   7️⃣ AWARD STAMP\r\n        // --------------------------------------\r\n        await prisma.customer.update({\r\n            where: { id: customer.id },\r\n            data: {\r\n                stampCount: { increment: 1 },\r\n                totalVisits: { increment: 1 },\r\n                lastVisit: new Date()\r\n            }\r\n        });\r\n\r\n        // --------------------------------------\r\n        //   8️⃣ TRANSACTION LOG\r\n        // --------------------------------------\r\n        await prisma.transaction.create({\r\n            data: {\r\n                id: `txn_${crypto.randomUUID()}`,\r\n                shopId,\r\n                customerId: customer.id,\r\n                amount,\r\n                status: \"success\",\r\n                upiId,\r\n                method: \"UPI_SCREENSHOT\"\r\n            }\r\n        });\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            message: \"Stamp added!\",\r\n            scanId: scan.id\r\n        });\r\n\r\n    } catch (err) {\r\n        console.error(\"VERIFY ERROR →\", err);\r\n        return NextResponse.json({ error: \"Server Error\" }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}