{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 106, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/awsSes.js"],"sourcesContent":["import { SESClient } from \"@aws-sdk/client-ses\";\r\n\r\nexport const sesClient = new SESClient({\r\n  region: process.env.AWS_REGION,\r\n  credentials: {\r\n    accessKeyId: process.env.AWS_ACCESS_KEY_ID,\r\n    secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,\r\n  },\r\n});\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,MAAM,YAAY,IAAI,uMAAS,CAAC;IACrC,QAAQ,QAAQ,GAAG,CAAC,UAAU;IAC9B,aAAa;QACX,aAAa,QAAQ,GAAG,CAAC,iBAAiB;QAC1C,iBAAiB,QAAQ,GAAG,CAAC,qBAAqB;IACpD;AACF"}},
    {"offset": {"line": 123, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/sendEmail.js"],"sourcesContent":["import { SendEmailCommand } from \"@aws-sdk/client-ses\";\r\nimport { sesClient } from \"./awsSes\";\r\n\r\nexport async function sendEmail({ to, subject, text, html }) {\r\n    const command = new SendEmailCommand({\r\n        Source: `Stampi <${process.env.SES_FROM_EMAIL}>`,\r\n        ReplyToAddresses: [\"support@stampi.in\"], // ðŸ‘ˆ important\r\n        Destination: {\r\n            ToAddresses: [to],\r\n        },\r\n        Message: {\r\n            Subject: { Data: subject, Charset: \"UTF-8\" },\r\n            Body: {\r\n                ...(html\r\n                    ? { Html: { Data: html, Charset: \"UTF-8\" } }\r\n                    : { Text: { Data: text, Charset: \"UTF-8\" } }),\r\n            },\r\n        },\r\n    });\r\n\r\n    return sesClient.send(command);\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,UAAU,EAAE,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,IAAI,EAAE;IACvD,MAAM,UAAU,IAAI,iOAAgB,CAAC;QACjC,QAAQ,CAAC,QAAQ,EAAE,QAAQ,GAAG,CAAC,cAAc,CAAC,CAAC,CAAC;QAChD,kBAAkB;YAAC;SAAoB;QACvC,aAAa;YACT,aAAa;gBAAC;aAAG;QACrB;QACA,SAAS;YACL,SAAS;gBAAE,MAAM;gBAAS,SAAS;YAAQ;YAC3C,MAAM;gBACF,GAAI,OACE;oBAAE,MAAM;wBAAE,MAAM;wBAAM,SAAS;oBAAQ;gBAAE,IACzC;oBAAE,MAAM;wBAAE,MAAM;wBAAM,SAAS;oBAAQ;gBAAE,CAAC;YACpD;QACJ;IACJ;IAEA,OAAO,4HAAS,CAAC,IAAI,CAAC;AAC1B"}},
    {"offset": {"line": 168, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/templates/baseEmail.js"],"sourcesContent":["export function baseEmailTemplate({ title, content }) {\r\n    return `\r\n  <!DOCTYPE html>\r\n  <html>\r\n    <body style=\"margin:0;font-family:Arial;background:#f6f9fc;padding:20px\">\r\n      <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\">\r\n        <tr>\r\n          <td align=\"center\">\r\n            <table width=\"600\" style=\"background:#ffffff;border-radius:8px;padding:24px\">\r\n              <tr>\r\n                <td style=\"text-align:center;font-size:24px;font-weight:bold;color:#6247AA\">\r\n                  Stampi\r\n                </td>\r\n              </tr>\r\n\r\n              <tr><td style=\"padding:20px 0;font-size:18px;font-weight:bold\">\r\n                ${title}\r\n              </td></tr>\r\n\r\n              <tr><td style=\"font-size:15px;color:#444\">\r\n                ${content}\r\n              </td></tr>\r\n\r\n              <tr><td style=\"padding-top:30px;font-size:12px;color:#999;text-align:center\">\r\n                Â© ${new Date().getFullYear()} Stampi Â· All rights reserved\r\n              </td></tr>\r\n            </table>\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    </body>\r\n  </html>\r\n  `;\r\n}\r\n"],"names":[],"mappings":";;;;AAAO,SAAS,kBAAkB,EAAE,KAAK,EAAE,OAAO,EAAE;IAChD,OAAO,CAAC;;;;;;;;;;;;;;;gBAeI,EAAE,MAAM;;;;gBAIR,EAAE,QAAQ;;;;kBAIR,EAAE,IAAI,OAAO,WAAW,GAAG;;;;;;;;EAQ3C,CAAC;AACH"}},
    {"offset": {"line": 210, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/templates/otpEmail.js"],"sourcesContent":["import { baseEmailTemplate } from \"./baseEmail\";\r\n\r\nexport function otpEmailTemplate({ otp }) {\r\n    return baseEmailTemplate({\r\n        title: \"Your OTP Code\",\r\n        content: `\r\n      <p>Your one-time password (OTP) is:</p>\r\n\r\n      <div style=\"\r\n        font-size:32px;\r\n        font-weight:bold;\r\n        letter-spacing:6px;\r\n        background:#f3f0ff;\r\n        padding:16px;\r\n        text-align:center;\r\n        border-radius:6px;\r\n        margin:20px 0;\r\n      \">\r\n        ${otp}\r\n      </div>\r\n\r\n      <p>This OTP is valid for <b>5 minutes</b>.</p>\r\n      <p>If you didnâ€™t request this, you can safely ignore this email.</p>\r\n    `,\r\n    });\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,SAAS,iBAAiB,EAAE,GAAG,EAAE;IACpC,OAAO,IAAA,oJAAiB,EAAC;QACrB,OAAO;QACP,SAAS,CAAC;;;;;;;;;;;;;QAaV,EAAE,IAAI;;;;;IAKV,CAAC;IACD;AACJ"}},
    {"offset": {"line": 244, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/email/sendOtpEmail.js"],"sourcesContent":["import { sendEmail } from \"../sendEmail\";\r\nimport { otpEmailTemplate } from \"../templates/otpEmail\";\r\n\r\nexport async function sendOtpEmail({ to, otp }) {\r\n    return sendEmail({\r\n        to,\r\n        subject: \"Your Stampi OTP Code\",\r\n        html: otpEmailTemplate({ otp }),\r\n    });\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,aAAa,EAAE,EAAE,EAAE,GAAG,EAAE;IAC1C,OAAO,IAAA,+HAAS,EAAC;QACb;QACA,SAAS;QACT,MAAM,IAAA,kJAAgB,EAAC;YAAE;QAAI;IACjC;AACJ"}},
    {"offset": {"line": 265, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/lib/rateLimit.js"],"sourcesContent":["// lib/rateLimit.js\r\n\r\nconst rateLimitMap = new Map();\r\n\r\n/**\r\n * Simple rate limiter\r\n * @param {string} key - usually email or IP\r\n * @param {number} limit - max requests\r\n * @param {number} windowMs - time window in ms\r\n * @returns {boolean} allowed or not\r\n */\r\nexport function rateLimit(\r\n    key,\r\n    limit = 5,\r\n    windowMs = 5 * 60 * 1000 // 5 minutes\r\n) {\r\n    const now = Date.now();\r\n    const record = rateLimitMap.get(key);\r\n\r\n    // First request or window expired\r\n    if (!record || now - record.startTime > windowMs) {\r\n        rateLimitMap.set(key, {\r\n            count: 1,\r\n            startTime: now,\r\n        });\r\n        return true;\r\n    }\r\n\r\n    // Exceeded limit\r\n    if (record.count >= limit) {\r\n        return false;\r\n    }\r\n\r\n    // Increase count\r\n    record.count += 1;\r\n    rateLimitMap.set(key, record);\r\n\r\n    return true;\r\n}\r\n"],"names":[],"mappings":"AAAA,mBAAmB;;;;;AAEnB,MAAM,eAAe,IAAI;AASlB,SAAS,UACZ,GAAG,EACH,QAAQ,CAAC,EACT,WAAW,IAAI,KAAK,KAAK,YAAY;AAAb;IAExB,MAAM,MAAM,KAAK,GAAG;IACpB,MAAM,SAAS,aAAa,GAAG,CAAC;IAEhC,kCAAkC;IAClC,IAAI,CAAC,UAAU,MAAM,OAAO,SAAS,GAAG,UAAU;QAC9C,aAAa,GAAG,CAAC,KAAK;YAClB,OAAO;YACP,WAAW;QACf;QACA,OAAO;IACX;IAEA,iBAAiB;IACjB,IAAI,OAAO,KAAK,IAAI,OAAO;QACvB,OAAO;IACX;IAEA,iBAAiB;IACjB,OAAO,KAAK,IAAI;IAChB,aAAa,GAAG,CAAC,KAAK;IAEtB,OAAO;AACX"}},
    {"offset": {"line": 296, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/app/api/auth/otp/send/route.js"],"sourcesContent":["export const dynamic = \"force-dynamic\";\r\nexport const runtime = \"nodejs\";\r\n\r\nimport { NextResponse } from \"next/server\";\r\nimport { sendOtpEmail } from \"@/lib/email/sendOtpEmail\";\r\nimport { rateLimit } from \"@/lib/rateLimit\";\r\n\r\nexport async function POST(req) {\r\n  try {\r\n    // Lazy import Prisma (build-safe)\r\n    const { default: prisma } = await import(\"@/lib/prisma\");\r\n\r\n    const { email, purpose } = await req.json();\r\n\r\n    if (!email) {\r\n      return NextResponse.json(\r\n        { error: \"Email required\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Rate limit OTP requests\r\n    if (!rateLimit(email)) {\r\n      return NextResponse.json(\r\n        { error: \"Too many OTP requests. Please try again later.\" },\r\n        { status: 429 }\r\n      );\r\n    }\r\n\r\n    // Generate 6-digit OTP\r\n    const code = Math.floor(100000 + Math.random() * 900000).toString();\r\n    const expiresAt = new Date(Date.now() + 5 * 60 * 1000);\r\n\r\n    // Save OTP to DB\r\n    await prisma.otp.upsert({\r\n      where: { email },\r\n      update: {\r\n        code,\r\n        purpose,\r\n        expiresAt,\r\n      },\r\n      create: {\r\n        email,\r\n        code,\r\n        purpose,\r\n        expiresAt,\r\n      },\r\n    });\r\n\r\n    // âœ… Send OTP via AWS SES\r\n    await sendOtpEmail({\r\n      to: email,\r\n      otp: code,\r\n    });\r\n\r\n    return NextResponse.json({ success: true });\r\n\r\n  } catch (err) {\r\n    console.error(\"[otp send error]\", err);\r\n    return NextResponse.json(\r\n      { error: \"Server error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAGA;AACA;AACA;AALO,MAAM,UAAU;AAChB,MAAM,UAAU;;;;AAMhB,eAAe,KAAK,GAAG;IAC5B,IAAI;QACF,kCAAkC;QAClC,MAAM,EAAE,SAAS,MAAM,EAAE,GAAG;QAE5B,MAAM,EAAE,KAAK,EAAE,OAAO,EAAE,GAAG,MAAM,IAAI,IAAI;QAEzC,IAAI,CAAC,OAAO;YACV,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAiB,GAC1B;gBAAE,QAAQ;YAAI;QAElB;QAEA,0BAA0B;QAC1B,IAAI,CAAC,IAAA,+HAAS,EAAC,QAAQ;YACrB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAiD,GAC1D;gBAAE,QAAQ;YAAI;QAElB;QAEA,uBAAuB;QACvB,MAAM,OAAO,KAAK,KAAK,CAAC,SAAS,KAAK,MAAM,KAAK,QAAQ,QAAQ;QACjE,MAAM,YAAY,IAAI,KAAK,KAAK,GAAG,KAAK,IAAI,KAAK;QAEjD,iBAAiB;QACjB,MAAM,OAAO,GAAG,CAAC,MAAM,CAAC;YACtB,OAAO;gBAAE;YAAM;YACf,QAAQ;gBACN;gBACA;gBACA;YACF;YACA,QAAQ;gBACN;gBACA;gBACA;gBACA;YACF;QACF;QAEA,yBAAyB;QACzB,MAAM,IAAA,8IAAY,EAAC;YACjB,IAAI;YACJ,KAAK;QACP;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;IAE3C,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,oBAAoB;QAClC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAe,GACxB;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}