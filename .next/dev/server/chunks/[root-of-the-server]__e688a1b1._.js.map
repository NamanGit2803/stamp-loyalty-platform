{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/app/api/subscription/extend/route.js"],"sourcesContent":["export const dynamic = \"force-dynamic\";\r\nexport const runtime = \"nodejs\";\r\n\r\nimport { NextResponse } from \"next/server\";\r\n\r\nexport async function POST(req) {\r\n  try {\r\n    const { default: prisma } = await import(\"@/lib/prisma\");\r\n\r\n    // üîê Auth\r\n    const { shopId } = await req.json();\r\n    if (!shopId) {\r\n      return NextResponse.json({ error: \"Shop unauthorized!\" }, { status: 400 });\r\n    }\r\n\r\n    // üîç Fetch user subscription\r\n    const subscription = await prisma.subscription.findFirst({\r\n      where: { shopId },\r\n      include: { plan: true }\r\n    });\r\n\r\n    if (!subscription) {\r\n      return NextResponse.json({ error: \"Subscription not found\" }, { status: 404 });\r\n    }\r\n\r\n    const plan = subscription.plan;\r\n    if (!plan) {\r\n      return NextResponse.json({ error: \"Plan not found\" }, { status: 404 });\r\n    }\r\n\r\n    // üí° If subscription is already active\r\n    if (subscription.status === \"active\") {\r\n      return NextResponse.json({\r\n        alreadyActive: true,\r\n        message: \"Subscription already active until \" + subscription.nextBillingAt,\r\n      });\r\n    }\r\n\r\n    // üöÄ Create a Cashfree Subscription\r\n    const cashfreeSubId = \"sub_\" + Date.now();\r\n\r\n    // 1Ô∏è‚É£ Update DB first (pending payment)\r\n    await prisma.subscription.update({\r\n      where: { id: subscription.id },\r\n      data: {\r\n        status: \"pending\",\r\n        cashfreeSubscriptionId: cashfreeSubId,\r\n      }\r\n    });\r\n\r\n    // 2Ô∏è‚É£ Call Cashfree API\r\n    const payload = {\r\n      subscription_id: cashfreeSubId,\r\n      customer_details: {\r\n        customer_id: shopId,\r\n        customer_email: \"test@example.com\",\r\n        customer_phone: \"9999999999\",\r\n      },\r\n      subscription: {\r\n        charge_type: \"RECURRING\",\r\n        amount: plan.price,\r\n        currency: \"INR\",\r\n        frequency: \"MONTHLY\",\r\n        max_amount: plan.price + 200,\r\n        auth_type: \"UPI\",\r\n        auth_methods: [\"E_MANDATE\"],\r\n        total_due_amount: plan.price,\r\n        first_charge: true\r\n      },\r\n      order_meta: {\r\n        return_url: process.env.CASHFREE_RETURN_URL,\r\n        notify_url: process.env.CASHFREE_NOTIFY_URL\r\n      }\r\n    };\r\n\r\n    const resCF = await fetch(\r\n      \"https://sandbox.cashfree.com/pg/subscriptions\",\r\n      {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"x-client-id\": process.env.CF_APP_ID,\r\n          \"x-client-secret\": process.env.CF_SECRET,\r\n          \"Content-Type\": \"application/json\"\r\n        },\r\n        body: JSON.stringify(payload)\r\n      }\r\n    );\r\n\r\n    const data = await resCF.json();\r\n    console.log(\"CASHFREE:\", data);\r\n\r\n    if (!data?.data?.authorization_link) {\r\n      return NextResponse.json(\r\n        { error: \"Failed to create Cashfree subscription\", details: data },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // 3Ô∏è‚É£ Return mandate link to frontend\r\n    return NextResponse.json({\r\n      success: true,\r\n      mandateLink: data.data.authorization_link\r\n    });\r\n\r\n  } catch (err) {\r\n    console.error(err);\r\n    return NextResponse.json({ error: \"Server error\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAGA;AAHO,MAAM,UAAU;AAChB,MAAM,UAAU;;AAIhB,eAAe,KAAK,GAAG;IAC5B,IAAI;QACF,MAAM,EAAE,SAAS,MAAM,EAAE,GAAG;QAE5B,UAAU;QACV,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,IAAI,IAAI;QACjC,IAAI,CAAC,QAAQ;YACX,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAqB,GAAG;gBAAE,QAAQ;YAAI;QAC1E;QAEA,6BAA6B;QAC7B,MAAM,eAAe,MAAM,OAAO,YAAY,CAAC,SAAS,CAAC;YACvD,OAAO;gBAAE;YAAO;YAChB,SAAS;gBAAE,MAAM;YAAK;QACxB;QAEA,IAAI,CAAC,cAAc;YACjB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAyB,GAAG;gBAAE,QAAQ;YAAI;QAC9E;QAEA,MAAM,OAAO,aAAa,IAAI;QAC9B,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,uCAAuC;QACvC,IAAI,aAAa,MAAM,KAAK,UAAU;YACpC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,eAAe;gBACf,SAAS,uCAAuC,aAAa,aAAa;YAC5E;QACF;QAEA,oCAAoC;QACpC,MAAM,gBAAgB,SAAS,KAAK,GAAG;QAEvC,wCAAwC;QACxC,MAAM,OAAO,YAAY,CAAC,MAAM,CAAC;YAC/B,OAAO;gBAAE,IAAI,aAAa,EAAE;YAAC;YAC7B,MAAM;gBACJ,QAAQ;gBACR,wBAAwB;YAC1B;QACF;QAEA,wBAAwB;QACxB,MAAM,UAAU;YACd,iBAAiB;YACjB,kBAAkB;gBAChB,aAAa;gBACb,gBAAgB;gBAChB,gBAAgB;YAClB;YACA,cAAc;gBACZ,aAAa;gBACb,QAAQ,KAAK,KAAK;gBAClB,UAAU;gBACV,WAAW;gBACX,YAAY,KAAK,KAAK,GAAG;gBACzB,WAAW;gBACX,cAAc;oBAAC;iBAAY;gBAC3B,kBAAkB,KAAK,KAAK;gBAC5B,cAAc;YAChB;YACA,YAAY;gBACV,YAAY,QAAQ,GAAG,CAAC,mBAAmB;gBAC3C,YAAY,QAAQ,GAAG,CAAC,mBAAmB;YAC7C;QACF;QAEA,MAAM,QAAQ,MAAM,MAClB,iDACA;YACE,QAAQ;YACR,SAAS;gBACP,eAAe,QAAQ,GAAG,CAAC,SAAS;gBACpC,mBAAmB,QAAQ,GAAG,CAAC,SAAS;gBACxC,gBAAgB;YAClB;YACA,MAAM,KAAK,SAAS,CAAC;QACvB;QAGF,MAAM,OAAO,MAAM,MAAM,IAAI;QAC7B,QAAQ,GAAG,CAAC,aAAa;QAEzB,IAAI,CAAC,MAAM,MAAM,oBAAoB;YACnC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;gBAA0C,SAAS;YAAK,GACjE;gBAAE,QAAQ;YAAI;QAElB;QAEA,sCAAsC;QACtC,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,aAAa,KAAK,IAAI,CAAC,kBAAkB;QAC3C;IAEF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC;QACd,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;AACF"}}]
}