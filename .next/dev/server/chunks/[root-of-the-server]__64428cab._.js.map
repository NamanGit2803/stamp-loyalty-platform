{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///E:/Project%20Files/Earning-model/stamp-card-project/stamp-loyalty-platform/app/api/subscription/extend/route.js"],"sourcesContent":["export const dynamic = \"force-dynamic\";\r\nexport const runtime = \"nodejs\";\r\n\r\nimport { NextResponse } from \"next/server\";\r\nimport { nanoid } from \"nanoid\";\r\n\r\nexport async function POST(req) {\r\n  try {\r\n    const { default: prisma } = await import(\"@/lib/prisma\");\r\n\r\n    const { shopId } = await req.json();\r\n    if (!shopId) {\r\n      return NextResponse.json({ error: \"shopId required\" }, { status: 400 });\r\n    }\r\n\r\n    // Fetch shop + owner\r\n    const shop = await prisma.shop.findFirst({\r\n      where: { id: shopId },\r\n      include: { owner: true }\r\n    });\r\n\r\n    if (!shop) {\r\n      return NextResponse.json({ error: \"Shop not found\" }, { status: 404 });\r\n    }\r\n\r\n    // Fetch subscription + plan\r\n    const subscription = await prisma.subscription.findFirst({\r\n      where: { shopId },\r\n      include: { plan: true }\r\n    });\r\n\r\n    if (!subscription) {\r\n      return NextResponse.json({ error: \"Subscription not found\" }, { status: 404 });\r\n    }\r\n\r\n    const plan = subscription.plan;\r\n\r\n    if (!plan) {\r\n      return NextResponse.json({ error: \"Plan not found\" }, { status: 404 });\r\n    }\r\n\r\n    if (!plan.cashfreePlanId) {\r\n      return NextResponse.json(\r\n        { error: \"cashfreePlanId missing in DB plan\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Already active?\r\n    if (subscription.status === \"active\") {\r\n      return NextResponse.json({\r\n        alreadyActive: true,\r\n        message: \"Subscription already active\",\r\n      });\r\n    }\r\n\r\n    // --------------------------------------------------------\r\n    // 1Ô∏è‚É£ Create Cashfree Subscription ID\r\n    // --------------------------------------------------------\r\n    const cashfreeSubId = `cSub_${nanoid(8)}`;\r\n\r\n    await prisma.subscription.update({\r\n      where: { id: subscription.id },\r\n      data: {\r\n        status: \"pending\",\r\n        cashfreeSubscriptionId: cashfreeSubId\r\n      }\r\n    });\r\n\r\n\r\n    // --------------------------------------------------------\r\n    // 2Ô∏è‚É£ Create Cashfree Subscription (Mandatory plan_id from dashboard)\r\n    // --------------------------------------------------------\r\n    const createRes = await fetch(\r\n      \"https://sandbox.cashfree.com/pg/subscriptions\",\r\n      {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"x-client-id\": process.env.CF_APP_ID,\r\n          \"x-client-secret\": process.env.CF_SECRET,\r\n          \"x-api-version\": \"2023-08-01\",\r\n          \"Content-Type\": \"application/json\"\r\n        },\r\n        body: JSON.stringify({\r\n          subscription_id: cashfreeSubId,\r\n\r\n          plan_details: {\r\n            plan_id: plan.cashfreePlanId,         // üëà CORRECT VALUE\r\n            plan_name: plan.name,\r\n            plan_type: \"PERIODIC\",\r\n            plan_currency: \"INR\",\r\n            plan_recurring_amount: plan.price,\r\n            plan_interval_type: \"MONTH\",\r\n            plan_intervals: 1\r\n          },\r\n\r\n          customer_details: {\r\n            customer_id: shopId,\r\n            customer_email: shop.owner.email,\r\n            customer_phone: shop.phone\r\n          },\r\n\r\n          subscription_meta: {\r\n            return_url: process.env.CASHFREE_RETURN_URL\r\n          }\r\n        })\r\n      }\r\n    );\r\n\r\n    const createData = await createRes.json();\r\n    console.log(\"CREATE SUBSCRIPTION:\", createData);\r\n\r\n\r\n    // --------------------------------------------------------\r\n    // 3Ô∏è‚É£ Mandate Authorization Link\r\n    // --------------------------------------------------------\r\n    const mandateLink =\r\n      createData?.authorization_details?.authorization_link ||\r\n      createData?.authorization_link ||\r\n      null;\r\n\r\n    if (!mandateLink) {\r\n      return NextResponse.json(\r\n        {\r\n          error: \"Authorization link not returned by Cashfree\",\r\n          details: createData\r\n        },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n\r\n    // --------------------------------------------------------\r\n    // 4Ô∏è‚É£ Return Mandate Link\r\n    // --------------------------------------------------------\r\n    return NextResponse.json({\r\n      success: true,\r\n      mandateLink\r\n    });\r\n\r\n  } catch (err) {\r\n    console.error(\"EXTEND API ERROR:\", err);\r\n    return NextResponse.json({ error: \"Server error\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}