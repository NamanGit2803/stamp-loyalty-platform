{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/lib/prisma.js"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\r\n\r\n// Prevent multiple instances of Prisma Client in dev mode\r\nconst globalForPrisma = globalThis;\r\n\r\nexport const prisma =\r\n  globalForPrisma.prisma ||\r\n  new PrismaClient({\r\n    log: [\"query\", \"error\", \"warn\"], // optional but helpful\r\n  });\r\n\r\nif (process.env.NODE_ENV !== \"production\") {\r\n  globalForPrisma.prisma = prisma;\r\n}\r\n\r\nexport default prisma;\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,0DAA0D;AAC1D,MAAM,kBAAkB;AAEjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,qKAAY,CAAC;IACf,KAAK;QAAC;QAAS;QAAS;KAAO;AACjC;AAEF,wCAA2C;IACzC,gBAAgB,MAAM,GAAG;AAC3B;uCAEe"}},
    {"offset": {"line": 41, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/middleware.js"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { jwtVerify } from \"jose\";\r\nimport { prisma } from \"@/lib/prisma\";\r\n\r\nexport async function middleware(req) {\r\n  const pathname = req.nextUrl.pathname;\r\n\r\n  // -----------------------------\r\n  // 1Ô∏è‚É£ Detect routes\r\n  // -----------------------------\r\n  const isShopPath = pathname.startsWith(\"/shop/\");\r\n  const shopMatch = pathname.match(/^\\/shop\\/(shop_[A-Za-z0-9]+)/);\r\n  const requestedShopId = shopMatch?.[1] || null;\r\n  const isValidShopIdFormat = Boolean(requestedShopId);\r\n\r\n  const isAdminRoute = pathname.startsWith(\"/admin\");\r\n  const isShopApi = pathname.startsWith(\"/api/shop\");\r\n  const isAdminApi = pathname.startsWith(\"/api/admin\");\r\n\r\n  const isPrivate = isShopPath || isAdminRoute || isShopApi || isAdminApi;\r\n\r\n  if (!isPrivate) return NextResponse.next();\r\n\r\n  // -----------------------------\r\n  // 2Ô∏è‚É£ JWT auth check\r\n  // -----------------------------\r\n  const token = req.cookies.get(\"token\")?.value;\r\n\r\n  if (!token) {\r\n    return NextResponse.redirect(new URL(\"/login\", req.url));\r\n  }\r\n\r\n  const secret = new TextEncoder().encode(process.env.JWT_SECRET);\r\n\r\n  let user;\r\n  try {\r\n    const { payload } = await jwtVerify(token, secret);\r\n    user = payload;\r\n  } catch (err) {\r\n    return NextResponse.redirect(new URL(\"/login\", req.url));\r\n  }\r\n\r\n  // -----------------------------\r\n  // 3Ô∏è‚É£ Admin protection\r\n  // -----------------------------\r\n  if (isAdminRoute || isAdminApi) {\r\n    if (user.role !== \"ADMIN\") {\r\n      return NextResponse.redirect(new URL(\"/\", req.url));\r\n    }\r\n    return NextResponse.next();\r\n  }\r\n\r\n  // -----------------------------\r\n  // 4Ô∏è‚É£ SHOP pages protection (+ subscription check)\r\n  // -----------------------------\r\n  if (isShopPath) {\r\n    if (user.role !== \"SHOP\") {\r\n      return NextResponse.redirect(new URL(\"/\", req.url));\r\n    }\r\n\r\n    if (!isValidShopIdFormat) {\r\n      return NextResponse.redirect(new URL(\"/\", req.url));\r\n    }\r\n\r\n    // ------------------------------------------\r\n    // ‚≠ê DB-based shop ownership check\r\n    // ------------------------------------------\r\n    const shop = await prisma.shop.findUnique({\r\n      where: { id: requestedShopId }\r\n    });\r\n\r\n    // ‚ùå Shop doesn't exist\r\n    if (!shop) {\r\n      return NextResponse.redirect(new URL(\"/\", req.url));\r\n    }\r\n\r\n    // ‚ùå Shop does NOT belong to logged-in user\r\n    if (shop.ownerEmail !== user.email) {\r\n      return NextResponse.redirect(new URL(\"/\", req.url));\r\n    }\r\n\r\n    // ------------------------------------------\r\n    // ‚≠ê 5Ô∏è‚É£ Subscription + Trial Logic\r\n    // ------------------------------------------\r\n    const subscription = await prisma.subscription.findFirst({\r\n      where: { shopId: requestedShopId }\r\n    });\r\n\r\n    // ‚ùå No subscription = trial never started\r\n    if (!subscription) {\r\n      return NextResponse.redirect(new URL(\"/plans\", req.url));\r\n    }\r\n\r\n    const now = new Date();\r\n    const trialEnds = new Date(subscription.trialEndsAt);\r\n    const nextBilling = new Date(subscription.nextBillingAt);\r\n\r\n    // üü¢ Trial active\r\n    if (now <= trialEnds) {\r\n      return NextResponse.next();\r\n    }\r\n\r\n    // üî¥ Trial expired and no payment\r\n    if (now > trialEnds && now > nextBilling) {\r\n      return NextResponse.redirect(new URL(\"/billing\", req.url));\r\n    }\r\n\r\n    // üü¢ Paid active\r\n    return NextResponse.next();\r\n  }\r\n\r\n  // -----------------------------\r\n  // 6Ô∏è‚É£ SHOP API protection\r\n  // -----------------------------\r\n  if (isShopApi) {\r\n    if (user.role !== \"SHOP\") {\r\n      return NextResponse.json({ error: \"Forbidden\" }, { status: 403 });\r\n    }\r\n    return NextResponse.next();\r\n  }\r\n\r\n  return NextResponse.next();\r\n}\r\n\r\nexport const config = {\r\n  matcher: [\"/((?!_next|.*\\\\..*).*)\"],\r\n};\r\n"],"names":[],"mappings":"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"}}]
}