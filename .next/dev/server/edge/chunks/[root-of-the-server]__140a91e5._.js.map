{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/middleware.js"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { jwtVerify } from \"jose\";\r\n\r\nexport async function middleware(req) {\r\n  const pathname = req.nextUrl.pathname;\r\n\r\n  // -----------------------------\r\n  // 1Ô∏è‚É£ Detect protected routes\r\n  // -----------------------------\r\n  const isShopPath = pathname.startsWith(\"/shop/\");\r\n  const shopMatch = pathname.match(/^\\/shop\\/(shop_[A-Za-z0-9_-]+)/);;\r\n  const requestedShopId = shopMatch?.[1] || null;\r\n  const isValidShopIdFormat = Boolean(requestedShopId);\r\n\r\n  const isAdminRoute = pathname.startsWith(\"/admin\");\r\n  const isShopApi = pathname.startsWith(\"/api/shop\");\r\n  const isAdminApi = pathname.startsWith(\"/api/admin\");\r\n\r\n  const isPrivate = isShopPath || isAdminRoute || isShopApi || isAdminApi;\r\n\r\n  if (!isPrivate) return NextResponse.next();\r\n\r\n  // -----------------------------\r\n  // 2Ô∏è‚É£ JWT auth check\r\n  // -----------------------------\r\n  const token = req.cookies.get(\"token\")?.value;\r\n\r\n  if (!token) {\r\n    return NextResponse.redirect(new URL(\"/login\", req.url));\r\n  }\r\n\r\n  const secret = new TextEncoder().encode(process.env.JWT_SECRET);\r\n\r\n  let user;\r\n  try {\r\n    const { payload } = await jwtVerify(token, secret);\r\n    user = payload; // { email, name, role, iat, exp }\r\n  } catch (err) {\r\n    return NextResponse.redirect(new URL(\"/login\", req.url));\r\n  }\r\n\r\n  // -----------------------------\r\n  // 3Ô∏è‚É£ Admin protection\r\n  // -----------------------------\r\n  if (isAdminRoute || isAdminApi) {\r\n    if (user.role !== \"ADMIN\") {\r\n      return NextResponse.redirect(new URL(\"/\", req.url));\r\n    }\r\n    return NextResponse.next();\r\n  }\r\n\r\n  // -----------------------------\r\n  // 4Ô∏è‚É£ SHOP pages protection\r\n  // -----------------------------\r\n  if (isShopPath) {\r\n    if (user.role !== \"SHOP\") {\r\n      return NextResponse.redirect(new URL(\"/\", req.url));\r\n    }\r\n\r\n\r\n    if (!isValidShopIdFormat) {\r\n      return NextResponse.redirect(new URL(\"/\", req.url));\r\n    }\r\n\r\n\r\n    // --------------------------------------------------\r\n    // ‚≠ê 5Ô∏è‚É£ CALL INTERNAL API FOR SHOP + SUBSCRIPTION CHECK\r\n    // --------------------------------------------------\r\n    const resp = await fetch(`${req.nextUrl.origin}/api/internal/subscription-check`, {\r\n      method: \"POST\",\r\n      body: JSON.stringify({\r\n        shopId: requestedShopId,\r\n        userEmail: user.email, // check ownership inside API\r\n      }),\r\n      headers: { \"Content-Type\": \"application/json\" }\r\n    });\r\n\r\n    const { status } = await resp.json();\r\n\r\n\r\n    // -----------------------------\r\n    // üö¶ Handle Subscription Result\r\n    // -----------------------------\r\n\r\n    if (status === \"NO_SHOP\" || status === \"NOT_OWNER\") {\r\n      return NextResponse.redirect(new URL(\"/\", req.url));\r\n    }\r\n\r\n    if (status === \"NO_SUBSCRIPTION\") {\r\n      return NextResponse.redirect(new URL(\"/plans\", req.url));\r\n    }\r\n\r\n    if (status === \"TRIAL_ACTIVE\") {\r\n      return NextResponse.next();\r\n    }\r\n\r\n    if (status === \"EXPIRED\") {\r\n      return NextResponse.redirect(new URL(\"/billing\", req.url));\r\n    }\r\n\r\n    if (status === \"PAID_ACTIVE\") {\r\n      return NextResponse.next();\r\n    }\r\n\r\n    // fallback (should never happen)\r\n    return NextResponse.redirect(new URL(\"/\", req.url));\r\n  }\r\n\r\n  // -----------------------------\r\n  // 6Ô∏è‚É£ SHOP API protection\r\n  // -----------------------------\r\n  if (isShopApi) {\r\n    if (user.role !== \"SHOP\") {\r\n      return NextResponse.json({ error: \"Forbidden\" }, { status: 403 });\r\n    }\r\n    return NextResponse.next();\r\n  }\r\n\r\n  return NextResponse.next();\r\n}\r\n\r\nexport const config = {\r\n  matcher: [\"/((?!_next|.*\\\\..*).*)\"],\r\n};\r\n"],"names":[],"mappings":"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"}}]
}